<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 仿写 RSS 阅读器 Unread 下拉刷新 · 一鸣的博客</title><meta name="description" content="仿写 RSS 阅读器 Unread 下拉刷新 - iYiming"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.jpg"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://iYiming.me/atom.xml" title="一鸣的博客"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/jiajiayouba" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/iYiming" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">仿写 RSS 阅读器 Unread 下拉刷新</h1><div class="post-info">2016年5月22日</div><div class="post-content"><p>实现的效果如下：</p>
<p><img src="/images/custom_refresh_2/1.gif" alt="1"></p>
<a id="more"></a>
<h2 id="下拉刷新原理"><a href="#下拉刷新原理" class="headerlink" title="下拉刷新原理"></a>下拉刷新原理</h2><ul>
<li><code>UIScrollView</code> 的 <code>contentInset</code> 属性用于保持停留</li>
<li><code>UIScrollView</code> 的 <code>contentOffset</code> 属性获取偏移量。从而设置刷新动画状态</li>
</ul>
<h2 id="怎样方便重用"><a href="#怎样方便重用" class="headerlink" title="怎样方便重用"></a>怎样方便重用</h2><p>如何获取偏移量？  </p>
<p>有两种方式可以获得:</p>
<ol>
<li><p>在含有 <code>UIScrollView</code>（及其子类）控制器里面使用<code>UIScrollViewDelegate</code>，从而获取偏移量。  </p>
</li>
<li><p>使用 KVO，通过监听 <code>contentOffset</code>，很容易的就得到了偏移量。</p>
</li>
</ol>
<p>但是如果要在多个控制器中使用下拉刷新，那么每个控制器都实现<code>UIScrollViewDelegate</code> 或 KVO，繁琐且臃肿。</p>
<p>滚动视图（<code>UIScrollView</code> 及其子类）和下拉刷新视图是一起的，有下拉刷新的地方就有滚动视图。把下拉刷新视图添加在滚动视图上（<code>UIScrollView</code>及其子类），得到刷新视图就可以获得滚动视图。因此把监听写在刷新视图里，就不用到处写了。</p>
<p>还有个问题，我们如何给滚动视图添加下拉刷新视图呢？有没有简单的方式给滚动视图添加下拉刷新视图。我们可以使用分类，添加一个下拉刷新视图属性，只要我们给这个下拉刷新视图赋值，我们就把它添加到滚动视图上。</p>
<h2 id="实现效果中的-3-个动画"><a href="#实现效果中的-3-个动画" class="headerlink" title="实现效果中的 3 个动画"></a>实现效果中的 3 个动画</h2><h4 id="展开、关闭动画"><a href="#展开、关闭动画" class="headerlink" title="展开、关闭动画"></a>展开、关闭动画</h4><p>原先是使用 POP 实现的，这次使用多次动画的方式。代码如下，</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> 展开动画</div><div class="line"> </div><div class="line"> :param: animationLayer 动画Layer</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">spreadLayerAnimation</span><span class="params">(animationLayer: CALayer)</span></span>&#123;</div><div class="line">    layerWidthAnimation(animationLayer, width: <span class="number">100</span>, animationTypeStr: <span class="string">"Spread"</span>, animationIndexStr: <span class="string">"1"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> 关闭动画</div><div class="line"> </div><div class="line"> :param: animationLayer 关闭Layer</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">closeLayerAnimation</span><span class="params">(animationLayer: CALayer)</span></span>&#123;</div><div class="line">    layerWidthAnimation(animationLayer, width: <span class="number">0</span>, animationTypeStr: <span class="string">"Close"</span>, animationIndexStr: <span class="string">"1"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> 宽度动画</div><div class="line"> </div><div class="line"> :param: animationLayer    动画层</div><div class="line"> :param: width             宽度</div><div class="line"> :param: animationTypeStr  动画类型 展开 或 关闭</div><div class="line"> :param: animationIndexStr 动画索引</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">layerWidthAnimation</span><span class="params">(animationLayer: CALayer,width: CGFloat,animationTypeStr: String,animationIndexStr: String)</span></span>&#123;</div><div class="line">    <span class="keyword">let</span> screenWidth = <span class="type">CGRectGetWidth</span>(<span class="type">UIScreen</span>.mainScreen().bounds)</div><div class="line">    </div><div class="line">    <span class="keyword">let</span> animation = <span class="type">CABasicAnimation</span>(keyPath: <span class="string">"bounds.size.width"</span>)</div><div class="line">    animation.duration = <span class="number">0.13</span></div><div class="line">    animation.delegate = <span class="keyword">self</span></div><div class="line">    animation.toValue = <span class="type">NSNumber</span>(float: <span class="number">20</span>)</div><div class="line">    animation.setValue(animationLayer, forKey: <span class="string">"AnimationLayer"</span>)</div><div class="line">    animation.setValue(animationTypeStr, forKey: <span class="string">"AnimationType"</span>)</div><div class="line">    animation.setValue(animationIndexStr, forKey: <span class="string">"AnimationIndex"</span>)</div><div class="line">    animation.timingFunction = <span class="type">CAMediaTimingFunction</span>(name: kCAMediaTimingFunctionEaseInEaseOut)</div><div class="line">    animationLayer.addAnimation(animation, forKey: <span class="string">"animation"</span>)</div><div class="line">    animationLayer.frame = <span class="type">CGRect</span>(x: (screenWidth - width)/<span class="number">2.0</span>, y: animationLayer.frame.origin.y, width: <span class="type">CGFloat</span>(width), height: animationLayer.frame.size.height)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 动画结束</span></div><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">animationDidStop</span><span class="params">(anim: CAAnimation, finished flag: Bool)</span></span> &#123;</div><div class="line">    <span class="keyword">let</span> animationLayer = anim.valueForKey(<span class="string">"AnimationLayer"</span>) <span class="keyword">as</span>! <span class="type">CALayer</span></div><div class="line">    <span class="keyword">let</span> animationTypeStr = anim.valueForKey(<span class="string">"AnimationType"</span>) <span class="keyword">as</span>! <span class="type">String</span></div><div class="line">    <span class="keyword">let</span> animationIndexStr = anim.valueForKey(<span class="string">"AnimationIndex"</span>) <span class="keyword">as</span>! <span class="type">String</span></div><div class="line"></div><div class="line">    <span class="keyword">var</span> width:<span class="type">CGFloat</span> = <span class="number">0</span></div><div class="line">    <span class="keyword">if</span> animationIndexStr == <span class="string">"1"</span>&#123;</div><div class="line">        <span class="keyword">if</span> animationTypeStr == <span class="string">"Spread"</span>&#123;</div><div class="line">            width = <span class="number">20</span></div><div class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> animationTypeStr == <span class="string">"Close"</span>&#123;</div><div class="line">            width = <span class="number">20</span></div><div class="line">        &#125;</div><div class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> animationIndexStr == <span class="string">"2"</span>&#123;</div><div class="line">        <span class="keyword">if</span> animationTypeStr == <span class="string">"Spread"</span>&#123;</div><div class="line">            width = <span class="number">80</span></div><div class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> animationTypeStr == <span class="string">"Close"</span>&#123;</div><div class="line">            width = <span class="number">4</span></div><div class="line">        &#125;</div><div class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> animationIndexStr == <span class="string">"3"</span>&#123;</div><div class="line">        <span class="keyword">if</span> animationTypeStr == <span class="string">"Spread"</span>&#123;</div><div class="line">            width = <span class="number">40</span></div><div class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> animationTypeStr == <span class="string">"Close"</span>&#123;</div><div class="line">            <span class="keyword">return</span></div><div class="line">        &#125;</div><div class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> animationIndexStr == <span class="string">"4"</span>&#123;</div><div class="line">        <span class="keyword">if</span> animationTypeStr == <span class="string">"Spread"</span>&#123;</div><div class="line">            width = <span class="number">60</span></div><div class="line">        &#125;</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    layerWidthAnimation(animationLayer, width: width, animationTypeStr: animationTypeStr, animationIndexStr:<span class="type">String</span>(<span class="type">Int</span>(animationIndexStr)! + <span class="number">1</span>))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="旋转动画"><a href="#旋转动画" class="headerlink" title="旋转动画"></a>旋转动画</h4><p>其实就是沿着一定的路径进行旋转，使用 <code>CAKeyframeAnimation</code> 的 <code>path</code> 属性按照响应的贝塞尔曲线旋转。如下图：  </p>
<p><img src="/images/custom_refresh_2/2.gif" alt="2"></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 设置界面</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">settingUI</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">let</span> screenWidth = <span class="type">CGRectGetWidth</span>( <span class="type">UIScreen</span>.mainScreen().bounds)</div><div class="line">    </div><div class="line">    layer1.backgroundColor = <span class="type">UIColor</span>.redColor().<span class="type">CGColor</span></div><div class="line">    layer1.frame = <span class="type">CGRect</span>(x: (screenWidth - <span class="number">8</span>)/<span class="number">2.0</span>, y: <span class="number">100</span>, width: <span class="number">8</span>, height: <span class="number">8</span>)</div><div class="line">    layer1.cornerRadius = <span class="number">4</span></div><div class="line">    view.layer.addSublayer(layer1)</div><div class="line">    </div><div class="line">    </div><div class="line">    layer2.backgroundColor = <span class="type">UIColor</span>.redColor().<span class="type">CGColor</span></div><div class="line">    layer2.frame = <span class="type">CGRect</span>(x: (screenWidth - <span class="number">8</span>)/<span class="number">2.0</span>, y: <span class="number">120</span>, width: <span class="number">8</span>, height: <span class="number">8</span>)</div><div class="line">    layer2.cornerRadius = <span class="number">4</span></div><div class="line">    view.layer.addSublayer(layer2)</div><div class="line">    </div><div class="line">    </div><div class="line">    layer3.backgroundColor = <span class="type">UIColor</span>.redColor().<span class="type">CGColor</span></div><div class="line">    layer3.frame = <span class="type">CGRect</span>(x: (screenWidth - <span class="number">8</span>)/<span class="number">2.0</span>, y: <span class="number">140</span>, width: <span class="number">8</span>, height: <span class="number">8</span>)</div><div class="line">    layer3.cornerRadius = <span class="number">4</span></div><div class="line">    view.layer.addSublayer(layer3)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">startAnimation</span><span class="params">(sender: AnyObject)</span></span> &#123;</div><div class="line">    <span class="keyword">let</span> screenWidth = <span class="type">CGRectGetWidth</span>(<span class="type">UIScreen</span>.mainScreen().bounds)</div><div class="line">    </div><div class="line">    <span class="keyword">let</span> animation1 = <span class="type">CAKeyframeAnimation</span>(keyPath: <span class="string">"position"</span>)</div><div class="line">    animation1.delegate = <span class="keyword">self</span></div><div class="line">    animation1.duration = <span class="type">CFTimeInterval</span>(<span class="number">0.3</span>)</div><div class="line">    animation1.path = <span class="type">UIBezierPath</span>(arcCenter: <span class="type">CGPoint</span>(x:(screenWidth - <span class="number">8</span>)/<span class="number">2.0</span> + <span class="number">4</span>, y: <span class="number">124.0</span>),radius: <span class="type">CGFloat</span>(<span class="number">58</span>), startAngle:<span class="type">CGFloat</span>(-<span class="type">M_PI_2</span>), endAngle: <span class="type">CGFloat</span>(<span class="number">0</span>), clockwise: <span class="literal">true</span>).<span class="type">CGPath</span></div><div class="line">    animation1.timingFunction = <span class="type">CAMediaTimingFunction</span>(name: kCAMediaTimingFunctionEaseInEaseOut)</div><div class="line">    layer1.addAnimation(animation1, forKey: <span class="string">"rotationAnimation"</span>)</div><div class="line">    <span class="type">CATransaction</span>.begin()</div><div class="line">    <span class="type">CATransaction</span>.setDisableActions(<span class="literal">true</span>)</div><div class="line">    layer1.position = <span class="type">CGPoint</span>(x: (screenWidth - <span class="number">8</span>)/<span class="number">2.0</span> + <span class="number">58</span> + <span class="number">4</span>, y: <span class="number">124</span>)</div><div class="line">    <span class="type">CATransaction</span>.commit()</div><div class="line">    </div><div class="line">    <span class="keyword">let</span> animation3 = <span class="type">CAKeyframeAnimation</span>(keyPath: <span class="string">"position"</span>)</div><div class="line">    animation3.delegate = <span class="keyword">self</span></div><div class="line">    animation3.duration = <span class="type">CFTimeInterval</span>(<span class="number">0.3</span>)</div><div class="line">    animation3.path = <span class="type">UIBezierPath</span>(arcCenter: <span class="type">CGPoint</span>(x:(screenWidth - <span class="number">8</span>)/<span class="number">2.0</span> + <span class="number">4</span>, y: <span class="number">124.0</span>),radius: <span class="type">CGFloat</span>(<span class="number">58</span>), startAngle:<span class="type">CGFloat</span>(<span class="type">M_PI_2</span>), endAngle: <span class="type">CGFloat</span>(<span class="type">M_PI</span>), clockwise: <span class="literal">true</span>).<span class="type">CGPath</span></div><div class="line">    animation3.timingFunction = <span class="type">CAMediaTimingFunction</span>(name: kCAMediaTimingFunctionEaseInEaseOut)</div><div class="line">    layer3.addAnimation(animation3, forKey: <span class="string">"rotationAnimation"</span>)</div><div class="line">    <span class="type">CATransaction</span>.begin()</div><div class="line">    <span class="type">CATransaction</span>.setDisableActions(<span class="literal">true</span>)</div><div class="line">    layer3.position = <span class="type">CGPoint</span>(x: (screenWidth - <span class="number">8</span>)/<span class="number">2.0</span> - <span class="number">58</span> + <span class="number">4</span>, y: <span class="number">124</span>)</div><div class="line">    <span class="type">CATransaction</span>.commit()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="按顺序放大、改变颜色动画"><a href="#按顺序放大、改变颜色动画" class="headerlink" title="按顺序放大、改变颜色动画"></a>按顺序放大、改变颜色动画</h4><p>有三个 Layer，第一个 Layer 动画（放大、改变颜色）结束后（使用 <code>animationDidStop</code>协议方法），开始第二个动画然后依次类推。如下图：</p>
<p><img src="/images/custom_refresh_2/3.gif" alt="3"></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> circleShapeLayer1 = <span class="type">CAShapeLayer</span>()</div><div class="line"><span class="keyword">var</span> circleShapeLayer2 = <span class="type">CAShapeLayer</span>()</div><div class="line"><span class="keyword">var</span> circleShapeLayer3 = <span class="type">CAShapeLayer</span>()</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> 设置界面</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">settingUI</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">let</span> shapeWidth:<span class="type">CGFloat</span> = <span class="number">10</span></div><div class="line">    <span class="keyword">let</span> bezierCGPath =  <span class="type">UIBezierPath</span>(ovalInRect: <span class="type">CGRect</span>(x: <span class="number">0</span>, y: <span class="number">0</span>, width: shapeWidth, height: shapeWidth)).<span class="type">CGPath</span></div><div class="line">    </div><div class="line">    <span class="keyword">let</span> fillCGColor = <span class="type">UIColor</span>(red: <span class="number">200</span>/<span class="number">255.0</span>, green: <span class="number">200</span>/<span class="number">255.0</span>, blue: <span class="number">200</span>/<span class="number">255.0</span>, alpha: <span class="number">1.0</span>).<span class="type">CGColor</span></div><div class="line">    </div><div class="line">    <span class="keyword">let</span> screenWidth = <span class="type">CGRectGetWidth</span>(<span class="type">UIScreen</span>.mainScreen().bounds)</div><div class="line">    <span class="keyword">let</span> marginLeft = <span class="type">CGFloat</span>((screenWidth - <span class="number">70</span>)/<span class="number">2.0</span>)</div><div class="line">    </div><div class="line">    circleShapeLayer1.path = bezierCGPath</div><div class="line">    circleShapeLayer1.fillColor = fillCGColor</div><div class="line">    </div><div class="line">    circleShapeLayer1.frame = <span class="type">CGRect</span>(x: marginLeft, y: <span class="number">100</span>, width: shapeWidth, height: shapeWidth)</div><div class="line">    view.layer.addSublayer(circleShapeLayer1)</div><div class="line">    </div><div class="line">    circleShapeLayer2.path = bezierCGPath</div><div class="line">    circleShapeLayer2.fillColor = fillCGColor</div><div class="line">    circleShapeLayer2.frame = <span class="type">CGRect</span>(x: marginLeft + <span class="number">30</span>, y: <span class="number">100</span>, width: shapeWidth, height: shapeWidth)</div><div class="line">    view.layer.addSublayer(circleShapeLayer2)</div><div class="line">    </div><div class="line">    circleShapeLayer3.path = bezierCGPath</div><div class="line">    circleShapeLayer3.fillColor = fillCGColor</div><div class="line">    circleShapeLayer3.frame = <span class="type">CGRect</span>(x: marginLeft + <span class="number">60</span>, y: <span class="number">100</span>, width: shapeWidth, height: shapeWidth)</div><div class="line">    view.layer.addSublayer(circleShapeLayer3)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//开始动画</span></div><div class="line"><span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">startAnimationButtonClicked</span><span class="params">(sender: AnyObject)</span></span> &#123;</div><div class="line">    addLayerAnimation(circleShapeLayer1,layerTagStr: <span class="string">"1"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> 添加图层动画</div><div class="line"> </div><div class="line"> :param: layer       图层</div><div class="line"> :param: layerTagStr 图层 Tag</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">addLayerAnimation</span><span class="params">(layer: CAShapeLayer,layerTagStr: String)</span></span> &#123;</div><div class="line">    <span class="keyword">let</span> scaleKeyframeAnimation = <span class="type">CAKeyframeAnimation</span>(keyPath: <span class="string">"transform"</span>)</div><div class="line">    </div><div class="line">    <span class="keyword">let</span> t1 = <span class="type">CATransform3DMakeScale</span>(<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">0</span>)</div><div class="line">    <span class="keyword">let</span> t2 = <span class="type">CATransform3DMakeScale</span>(<span class="number">1.5</span>, <span class="number">1.5</span>, <span class="number">0</span>)</div><div class="line">    <span class="keyword">let</span> t3 = <span class="type">CATransform3DMakeScale</span>(<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">0</span>)</div><div class="line">    </div><div class="line">    scaleKeyframeAnimation.values = [<span class="type">NSValue</span>(<span class="type">CATransform3D</span>:t1),<span class="type">NSValue</span>(<span class="type">CATransform3D</span>:t2),<span class="type">NSValue</span>(<span class="type">CATransform3D</span>:t3)]</div><div class="line">    scaleKeyframeAnimation.keyTimes = [<span class="number">0</span>, <span class="number">0.5</span>, <span class="number">1</span>]</div><div class="line">    </div><div class="line">    <span class="keyword">let</span> normalCGColor = <span class="type">UIColor</span>(red: <span class="number">200</span>/<span class="number">255.0</span>, green: <span class="number">200</span>/<span class="number">255.0</span>, blue: <span class="number">200</span>/<span class="number">255.0</span>, alpha: <span class="number">1.0</span>).<span class="type">CGColor</span></div><div class="line">    <span class="keyword">let</span> highlightedColor = <span class="type">UIColor</span>(red: <span class="number">60</span>/<span class="number">255.0</span>, green: <span class="number">60</span>/<span class="number">255.0</span>, blue: <span class="number">60</span>/<span class="number">255.0</span>, alpha: <span class="number">1.0</span>).<span class="type">CGColor</span></div><div class="line">    <span class="keyword">let</span> colorKeyframeAnimation = <span class="type">CAKeyframeAnimation</span>(keyPath: <span class="string">"fillColor"</span>)</div><div class="line">    colorKeyframeAnimation.values = [normalCGColor,highlightedColor,normalCGColor]</div><div class="line">    colorKeyframeAnimation.keyTimes = [<span class="number">0</span>, <span class="number">0.5</span>, <span class="number">1</span>]</div><div class="line">    </div><div class="line">    <span class="keyword">let</span> groupAnimation = <span class="type">CAAnimationGroup</span>()</div><div class="line">    groupAnimation.duration = <span class="type">CFTimeInterval</span>(<span class="number">0.35</span>)</div><div class="line">    groupAnimation.animations = [scaleKeyframeAnimation,colorKeyframeAnimation]</div><div class="line">    groupAnimation.removedOnCompletion = <span class="literal">true</span></div><div class="line">    groupAnimation.setValue(layerTagStr, forKey: <span class="string">"LayerTag"</span>)</div><div class="line">    groupAnimation.delegate = <span class="keyword">self</span></div><div class="line">    </div><div class="line">    layer.addAnimation(groupAnimation, forKey: <span class="string">"scaleKeyframeAnimation"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 动画结束协议</span></div><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">animationDidStop</span><span class="params">(anim: CAAnimation, finished flag: Bool)</span></span> &#123;</div><div class="line">    <span class="keyword">let</span>  layerTagStr = anim.valueForKey(<span class="string">"LayerTag"</span>) <span class="keyword">as</span>! <span class="type">String</span></div><div class="line">    </div><div class="line">    <span class="keyword">if</span> layerTagStr == <span class="string">"1"</span>&#123;</div><div class="line">        addLayerAnimation(circleShapeLayer2,layerTagStr: <span class="string">"2"</span>)</div><div class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> layerTagStr == <span class="string">"2"</span>&#123;</div><div class="line">        addLayerAnimation(circleShapeLayer3,layerTagStr: <span class="string">"3"</span>)</div><div class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> layerTagStr == <span class="string">"3"</span>&#123;</div><div class="line">        addLayerAnimation(circleShapeLayer1,layerTagStr: <span class="string">"1"</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代码已传至 GitHub：<a href="https://github.com/iYiming/YMRefreshView" target="_blank" rel="external">https://github.com/iYiming/YMRefreshView</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/06/05/di-1-zhang-shou-xi-objective-c/" class="prev">上一篇</a><a href="/2016/05/08/xie-yi-ge-jian-yi-shi-pin-bo-fang-qi/" class="next">下一篇</a></div><div data-thread-key="2016/05/22/zi-ding-yi-xia-la-shua-xin/" data-title="仿写 RSS 阅读器 Unread 下拉刷新" data-url="http://iYiming.me/2016/05/22/zi-ding-yi-xia-la-shua-xin/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"jiajiayouba"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2014 - 2017 <a href="http://iYiming.me">iYiming</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1253468447'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s6.cnzz.com/z_stat.php%3Fid%3D1253468447%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?3cec0b24b46b86302d1aa3b050d4668f";var s = document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm, s);})();</script></body></html>