<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 每日爬取技术大牛微博生成 Markdown · 一鸣的博客</title><meta name="description" content="Python"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.jpg"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://iYiming.me/atom.xml" title="一鸣的博客"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/jiajiayouba" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/iYiming" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">每日爬取技术大牛微博生成 Markdown</h1><div class="post-info">2016年10月30日</div><div class="post-content"><p><img src="/images/weibo_spider/1.jpg" alt="微博爬虫"></p>
<p>一年前，自己开通了公众号，将每天微博上最新的 iOS 技术文章，制作成笔记的形式分享出来。持续了一年时间，最近因为创业，已经好些天没有更新了。最近有人向我反馈这个问题，我也拿比较忙没有时间推脱。</p>
<p>随着问的人越来越多，开始思考，怎么用技术的手段自动化生成这些笔记，想到前段时间学习到的 Python，想利用爬虫来解决这个问题。</p>
<a id="more"></a>
<p>本篇文章主要有以下内容：  </p>
<ol>
<li>分析微博网站。找到获取某个用户微博数据的 URL。</li>
<li>通过 URL 获取到微博内容。微博正文内容、转发数量、时间等。</li>
<li>清洗数据。这里我们要获取前一天转发量 &gt;= 20 的微博数据</li>
<li>按照日期生成并保存成 markdown 文件</li>
</ol>
<h2 id="分析微博网站"><a href="#分析微博网站" class="headerlink" title="分析微博网站"></a>分析微博网站</h2><p>我们爬取的是这个网站：</p>
<p><a href="http://weibo.cn/" target="_blank" rel="external">http://weibo.cn/</a></p>
<p>要获取某人的微博，比如要获取 @逻辑思维 的微博:</p>
<p><a href="http://weibo.cn/u/1853923717?page=1" target="_blank" rel="external">http://weibo.cn/u/1853923717?page=1</a></p>
<h2 id="获取微博内容"><a href="#获取微博内容" class="headerlink" title="获取微博内容"></a>获取微博内容</h2><p>下方代码获取的是 <a href="http://weibo.cn/u/1853923717?page=1" target="_blank" rel="external">@逻辑思维</a> 微博第 1 页网页源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> Request</div><div class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> urlopen</div><div class="line"></div><div class="line">url = <span class="string">'http://weibo.cn/u/1853923717?page=1'</span></div><div class="line">header = &#123;</div><div class="line">        <span class="string">"User-Agent"</span> : <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/54.0.2840.71 Safari/537.36"</span>,</div><div class="line">        <span class="string">"Connection"</span> : <span class="string">"keep-alive"</span>,</div><div class="line">        <span class="string">"Cache-Control"</span> : <span class="string">"max-age=0"</span>,</div><div class="line">        <span class="string">"Upgrade-Insecure-Requests"</span> : <span class="string">"1"</span>,</div><div class="line">        <span class="string">"Accept"</span> :<span class="string">"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8"</span>,</div><div class="line">        <span class="string">"Accept-Language"</span>:<span class="string">"zh-CN,zh;q=0.8,en;q=0.6,zh-TW;q=0.4,ja;q=0.2"</span>,</div><div class="line">        <span class="string">"Cookie"</span>: <span class="string">"这里填写你的 Cookie 值"</span></div><div class="line">&#125;</div><div class="line">    </div><div class="line">request = Request(url,<span class="keyword">None</span>,header)</div><div class="line">response = urlopen(request,timeout=<span class="number">1000</span>)</div><div class="line">    </div><div class="line">print(response.read())</div></pre></td></tr></table></figure>
<p>通过上面的网页，我们要找到以下数据：</p>
<ul>
<li>微博内容（包括 被转发的微博内容）</li>
<li>微博创建时间</li>
<li>微博转发数量</li>
<li>微博 URL 地址</li>
</ul>
<h4 id="获取单条微博所有内容"><a href="#获取单条微博所有内容" class="headerlink" title="获取单条微博所有内容"></a>获取单条微博所有内容</h4><p>这里的单条微博的所有内容，包括微博正文、转发数、转发时间等。</p>
<p><img src="/images/weibo_spider/2.png" alt="微博爬虫"></p>
<p>上代码：  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line">bsObj = BeautifulSoup(response.read(),<span class="string">"html.parser"</span>)</div><div class="line">cardListElement = bsObj.find_all(<span class="string">"div"</span>,&#123;<span class="string">"class"</span>:<span class="string">"c"</span>&#125;)</div><div class="line"></div><div class="line"><span class="keyword">for</span> cardElement <span class="keyword">in</span> cardListElement:</div><div class="line">    <span class="keyword">if</span> cardElement.get(<span class="string">'id'</span>) <span class="keyword">is</span> <span class="keyword">None</span>: <span class="comment"># 排除不是微博的数据</span></div><div class="line">        <span class="keyword">continue</span></div><div class="line">    <span class="keyword">if</span> cardElement.find(<span class="string">"span"</span>,&#123;<span class="string">"class"</span>:<span class="string">"kt"</span>&#125;) <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>: <span class="comment"># 排除置顶</span></div><div class="line">        <span class="keyword">continue</span></div><div class="line">    print(<span class="string">'cardElement:'</span>,cardElement)</div></pre></td></tr></table></figure>
<h4 id="获取微博正文"><a href="#获取微博正文" class="headerlink" title="获取微博正文"></a>获取微博正文</h4><p>这里的微博正文包括原始微博正文内容和转发微博的正文内容。</p>
<p>如何判断是否包含有转发微博:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">weiboContent = <span class="string">""</span> <span class="comment"># 微博内容</span></div><div class="line">haveRetweetWeibo = <span class="keyword">False</span> <span class="comment"># 是否有转发微博</span></div><div class="line"><span class="keyword">if</span> len(cardElement.find_all(text=<span class="string">'转发理由:'</span>)) != <span class="number">0</span>:<span class="comment"># 有转发理由就有转发</span></div><div class="line">    haveRetweetWeibo = <span class="keyword">True</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> haveRetweetWeibo: <span class="comment"># 有转发微博</span></div><div class="line">    repostReasonItems = cardElement.find_all(<span class="string">'a'</span>,&#123;<span class="string">'href'</span>: re.compile(<span class="string">'http://weibo.cn/attitude/*'</span>)&#125;)[<span class="number">0</span>].previous_siblings;</div><div class="line">    <span class="keyword">for</span> index,repostReasonItem <span class="keyword">in</span> enumerate(repostReasonItems): <span class="comment"># 需要反向拼接</span></div><div class="line">        weiboContent = repostReasonItem.string + weiboContent;</div><div class="line">        weiboContent = weiboContent[<span class="number">5</span>:] <span class="comment"># 去掉‘转发理由:’ 5 个字</span></div><div class="line"></div><div class="line">    weiboContent = weiboContent + <span class="string">'\n\n'</span> + str(cardElement.find(<span class="string">"span"</span>,&#123;<span class="string">"class"</span>:<span class="string">"ctt"</span>&#125;))</div><div class="line"><span class="keyword">else</span>: <span class="comment"># 没有转发微博</span></div><div class="line">    weiboContent = str(cardElement.find(<span class="string">"span"</span>,&#123;<span class="string">"class"</span>:<span class="string">"ctt"</span>&#125;))</div><div class="line">print(<span class="string">'weiboContent:'</span>, weiboContent)</div></pre></td></tr></table></figure>
<h4 id="微博创建时间"><a href="#微博创建时间" class="headerlink" title="微博创建时间"></a>微博创建时间</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"></div><div class="line">timeLongStr = cardElement.find(<span class="string">"span"</span>,&#123;<span class="string">"class"</span>:<span class="string">"ct"</span>&#125;).get_text()</div><div class="line">timeArray = timeLongStr.split(<span class="string">'\xa0'</span>)</div><div class="line">timeStr = timeArray[<span class="number">0</span>]</div></pre></td></tr></table></figure>
<p>这里获取的数据为 <code>今天 10:23</code>。</p>
<h4 id="微博转发数量"><a href="#微博转发数量" class="headerlink" title="微博转发数量"></a>微博转发数量</h4><p>微博转发数量包括原始微博的转发数量和转发微博的转发数量。</p>
<p>上代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 原始微博的转发数量</span></div><div class="line">repostCountStr = <span class="string">'0'</span></div><div class="line">repostItems = cardElement.find_all(<span class="string">'a'</span>,&#123;<span class="string">'href'</span>: re.compile(<span class="string">'http://weibo.cn/repost/*'</span>)&#125;) <span class="comment"># 找到转发标签</span></div><div class="line"><span class="keyword">for</span> repost <span class="keyword">in</span> repostItems:</div><div class="line">    repostCountLongStr = repost.get_text() <span class="comment"># 获取 '转发[100]'</span></div><div class="line">    repostCountStr = repostCountLongStr[<span class="number">3</span>:len(repostCountLongStr) - <span class="number">1</span>] <span class="comment"># 获取 100</span></div><div class="line">print(<span class="string">'转发数量:'</span>,repostCountStr,<span class="string">'\n\n'</span>)</div><div class="line"></div><div class="line">        </div><div class="line"><span class="comment"># 转发微博的转发数量</span></div><div class="line">repostWeiboRepostCountStr = <span class="string">'0'</span></div><div class="line">repostWeiboRepostItems = cardElement.find_all(<span class="string">"span"</span>,&#123;<span class="string">"class"</span>:<span class="string">"cmt"</span>&#125;)</div><div class="line"><span class="keyword">for</span> i,cmt <span class="keyword">in</span> enumerate(repostWeiboRepostItems):</div><div class="line">     <span class="keyword">if</span> i == <span class="number">2</span>: <span class="comment"># 找到转发标签</span></div><div class="line">         repostWeiboRepostCountLongStr = cmt.get_text() <span class="comment"># 获取 '原文转发[14]'</span></div><div class="line">         repostWeiboRepostCountStr = repostWeiboRepostCountLongStr[<span class="number">5</span>:len(repostWeiboRepostCountLongStr) - <span class="number">1</span>] <span class="comment"># 获取 '14'</span></div><div class="line">print(<span class="string">'转发微博的转发数量:'</span>,repostWeiboRepostCountStr,<span class="string">'\n\n'</span>)</div></pre></td></tr></table></figure>
<h4 id="微博-URL-地址"><a href="#微博-URL-地址" class="headerlink" title="微博 URL 地址"></a>微博 URL 地址</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">weiboURL = <span class="string">""</span></div><div class="line"><span class="keyword">for</span> ccA <span class="keyword">in</span> cardElement.find_all(<span class="string">"a"</span>,&#123;<span class="string">"class"</span>:<span class="string">"cc"</span>&#125;):</div><div class="line">    weiboURL = ccA[<span class="string">"href"</span>]</div></pre></td></tr></table></figure>
<h2 id="清洗数据"><a href="#清洗数据" class="headerlink" title="清洗数据"></a>清洗数据</h2><h4 id="转发量-gt-20"><a href="#转发量-gt-20" class="headerlink" title="转发量 &gt;= 20"></a>转发量 &gt;= 20</h4><p>因为我们抓取的技术文章，不是所有微博都是我们抓取的对象，我这里设置一个条件：仅获取转发量 &gt;= 20 的微博数据。</p>
<p>转发量为：该微博转发量 + 转发微博的转发量</p>
<p>因为上面我们已经获取了这两个数据，做个判断就可以了。</p>
<h4 id="时间为前一天"><a href="#时间为前一天" class="headerlink" title="时间为前一天"></a>时间为前一天</h4><p>我们知道当前时间，也就知道昨天的起始时间和结束时间，分别转化为时间戳就可以了。上面的代码中我们知道了微博的创建时间，转化为时间戳就可以了。</p>
<p>故判断条件为：前一天开始时间戳 &lt;= 创建时间戳 &lt;= 前一天结束时间戳 </p>
<p>获取 昨日起始时间戳 和 昨日结束时间戳：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> time</div><div class="line"><span class="keyword">import</span> datetime</div><div class="line"></div><div class="line">structTime = time.localtime(time.time())</div><div class="line">yesterdayCurrentTime = datetime.datetime.now() - datetime.timedelta(days=<span class="number">1</span>) <span class="comment"># 获取昨天此刻时间</span></div><div class="line">yesterdayStructTime = yesterdayCurrentTime.timetuple()</div><div class="line"></div><div class="line">yesterdayYear = yesterdayStructTime.tm_year <span class="comment"># 昨天 年份</span></div><div class="line">yesterdayMonth = yesterdayStructTime.tm_mon <span class="comment"># 昨天 月份</span></div><div class="line">yesterdayDay = yesterdayStructTime.tm_mday <span class="comment"># 昨天 多少号</span></div><div class="line"></div><div class="line"><span class="comment"># 昨日起始时间戳</span></div><div class="line">yesterdayStartTime = <span class="string">"%d-%d-%d 00:00:00"</span>%(yesterdayYear, yesterdayMonth, yesterdayDay)</div><div class="line">yesterdayStartTimeArray = time.strptime(yesterdayStartTime, <span class="string">"%Y-%m-%d %H:%M:%S"</span>)</div><div class="line">yesterdayStartTimeStamp = int(time.mktime(yesterdayStartTimeArray))</div><div class="line"></div><div class="line"><span class="comment"># 昨日结束时间戳</span></div><div class="line">yesterdayEndTime = <span class="string">"%d-%d-%d 23:59:59"</span>%(yesterdayYear, yesterdayMonth, yesterdayDay)</div><div class="line">yesterdayEndTimeArray = time.strptime(yesterdayEndTime, <span class="string">"%Y-%m-%d %H:%M:%S"</span>)</div><div class="line">yesterdayEndTimeStamp = int(time.mktime(yesterdayEndTimeArray))</div></pre></td></tr></table></figure>
<p>微博创建时间时间戳：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">timeLongStr = cardElement.find(<span class="string">"span"</span>,&#123;<span class="string">"class"</span>:<span class="string">"ct"</span>&#125;).get_text()</div><div class="line">timeArray = timeLongStr.split(<span class="string">'\xa0'</span>)</div><div class="line"></div><div class="line">timeStr = timeArray[<span class="number">0</span>]</div><div class="line">seperatorArray = timeStr.split(<span class="string">'-'</span>)</div><div class="line"></div><div class="line"><span class="keyword">if</span> len(seperatorArray) == <span class="number">1</span>:</div><div class="line">    structTime = time.localtime(time.time())</div><div class="line">    currentTime = datetime.datetime.now()</div><div class="line">    currenStructTime = yesterdayCurrentTime.timetuple()</div><div class="line"></div><div class="line">    currenYear = currenStructTime.tm_year <span class="comment"># 今天 年份</span></div><div class="line">    timeStr = str(currenYear) + <span class="string">'年'</span> + timeStr</div><div class="line">timeStr = timeStr.replace(<span class="string">'年'</span>,<span class="string">'-'</span>)</div><div class="line">timeStr = timeStr.replace(<span class="string">'月'</span>,<span class="string">'-'</span>)</div><div class="line">timeStr = timeStr.replace(<span class="string">'日'</span>,<span class="string">''</span>)</div><div class="line"></div><div class="line">colonArray = timeStr.split(<span class="string">':'</span>)</div><div class="line"><span class="keyword">if</span> len(colonArray) == <span class="number">2</span>:</div><div class="line">    timeStr = timeStr + <span class="string">':00'</span></div><div class="line"></div><div class="line"><span class="keyword">try</span>:</div><div class="line">    weiboCreateTimeArray = time.strptime(timeStr, <span class="string">"%Y-%m-%d %H:%M:%S"</span>)</div><div class="line">        </div><div class="line">    createdTimestamp = int(time.mktime(weiboCreateTimeArray))</div><div class="line">    print(<span class="string">"timeStr:"</span>,timeStr)</div><div class="line">    print(<span class="string">'createdTimestamp:'</span>,str(createdTimestamp))</div><div class="line">    print(<span class="string">'yesterdayStartTimeStamp:'</span>,str(yesterdayStartTimeStamp),<span class="string">' yesterdayEndTimeStamp:'</span>,str(yesterdayEndTimeStamp))</div><div class="line"></div><div class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> err:</div><div class="line">     print(<span class="string">"timeStr:"</span>,timeStr)</div><div class="line">     print(err)</div></pre></td></tr></table></figure>
<h4 id="微博-URL-优化"><a href="#微博-URL-优化" class="headerlink" title="微博 URL 优化"></a>微博 URL 优化</h4><p>看到打印出来的地址是这个样子的：</p>
<p><a href="http://weibo.cn/comment/EhdDavwxC?uid=1853923717&amp;rl=0#cmtfrm" target="_blank" rel="external">http://weibo.cn/comment/EhdDavwxC?uid=1853923717&amp;rl=0#cmtfrm</a></p>
<p>不是特别好看，但是我们发现移动版 <a href="http://m.weibo.cn" target="_blank" rel="external">http://m.weibo.cn</a> 下的挺好看：</p>
<p><a href="http://m.weibo.cn/1853923717/EhdDavwxC" target="_blank" rel="external">http://m.weibo.cn/1853923717/EhdDavwxC</a></p>
<p>用下面代码转换下就可以了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">url1 = weiboURL.replace(<span class="string">'weibo.cn'</span>,<span class="string">'m.weibo.cn'</span>)</div><div class="line">url1Array = url1.split(<span class="string">'='</span>)</div><div class="line">uidArray = url1Array[<span class="number">1</span>].split(<span class="string">'&amp;'</span>)</div><div class="line">uid = uidArray[<span class="number">0</span>]</div><div class="line">weiboURL = url1.replace(<span class="string">'comment'</span>,uid)</div><div class="line">weiboURL = re.sub(<span class="string">r'\?uid[\s\S]*'</span>,<span class="string">''</span>,weiboURL)</div></pre></td></tr></table></figure>
<h2 id="生成-markdown-文件"><a href="#生成-markdown-文件" class="headerlink" title="生成 markdown 文件"></a>生成 markdown 文件</h2><p>也就是创建 md 文件  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">mdContent = <span class="string">'....'</span></div><div class="line"></div><div class="line">fileName = str(yesterdayYear) + <span class="string">"-"</span> + str(yesterdayMonth) + <span class="string">'-'</span> + str(yesterdayDay)</div><div class="line">filePath = <span class="string">'./notes/'</span> + fileName + <span class="string">'.md'</span></div><div class="line">print(<span class="string">'filePath:'</span>,filePath,<span class="string">'mdContent:'</span>,mdContent)</div><div class="line">f = open(filePath,mode=<span class="string">'w'</span>,encoding=<span class="string">"UTF-8"</span>)</div><div class="line">f.write(mdContent)</div><div class="line">f.close()</div></pre></td></tr></table></figure>
<h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> urlopen</div><div class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> Request</div><div class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</div><div class="line"><span class="keyword">import</span> re</div><div class="line"><span class="keyword">import</span> time</div><div class="line"><span class="keyword">import</span> datetime</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">getWeibo</span><span class="params">(userWeiboID,pageIndex)</span>:</span></div><div class="line">    <span class="keyword">global</span> weiboIndex</div><div class="line">    <span class="keyword">global</span> mdContent</div><div class="line">    url = <span class="string">'http://weibo.cn/u/%s?page=%d'</span>%(userWeiboID,pageIndex)</div><div class="line">    header = &#123;</div><div class="line">        <span class="string">"User-Agent"</span> : <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/54.0.2840.71 Safari/537.36"</span>,</div><div class="line">        <span class="string">"Connection"</span> : <span class="string">"keep-alive"</span>,</div><div class="line">        <span class="string">"Cache-Control"</span> : <span class="string">"max-age=0"</span>,</div><div class="line">        <span class="string">"Upgrade-Insecure-Requests"</span> : <span class="string">"1"</span>,</div><div class="line">        <span class="string">"Accept"</span> :<span class="string">"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8"</span>,</div><div class="line">        <span class="string">"Accept-Language"</span>:<span class="string">"zh-CN,zh;q=0.8,en;q=0.6,zh-TW;q=0.4,ja;q=0.2"</span>,</div><div class="line">        <span class="string">"Cookie"</span>: <span class="string">"这里填写你的 Cookie 值"</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    request = Request(url,<span class="keyword">None</span>,header)</div><div class="line">    response = urlopen(request,timeout=<span class="number">1000</span>)</div><div class="line"></div><div class="line">    bsObj = BeautifulSoup(response.read(),<span class="string">"html.parser"</span>)</div><div class="line">    cardListElement = bsObj.find_all(<span class="string">"div"</span>,&#123;<span class="string">"class"</span>:<span class="string">"c"</span>&#125;)</div><div class="line">    print(url)</div><div class="line"></div><div class="line">    <span class="keyword">for</span> cardElement <span class="keyword">in</span> cardListElement:</div><div class="line">        <span class="keyword">if</span> cardElement.get(<span class="string">'id'</span>) <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">continue</span></div><div class="line">        <span class="keyword">if</span> cardElement.find(<span class="string">"span"</span>,&#123;<span class="string">"class"</span>:<span class="string">"kt"</span>&#125;) <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">continue</span></div><div class="line">        <span class="comment"># 创建时间</span></div><div class="line">        timeLongStr = cardElement.find(<span class="string">"span"</span>,&#123;<span class="string">"class"</span>:<span class="string">"ct"</span>&#125;).get_text()</div><div class="line">        timeArray = timeLongStr.split(<span class="string">'\xa0'</span>)</div><div class="line"></div><div class="line">        timeStr = timeArray[<span class="number">0</span>]</div><div class="line">        seperatorArray = timeStr.split(<span class="string">'-'</span>)</div><div class="line"></div><div class="line">        <span class="keyword">if</span> len(seperatorArray) == <span class="number">1</span>:</div><div class="line">            structTime = time.localtime(time.time())</div><div class="line">            currentTime = datetime.datetime.now()</div><div class="line">            currenStructTime = yesterdayCurrentTime.timetuple()</div><div class="line">                        </div><div class="line">            currenYear = currenStructTime.tm_year <span class="comment"># 今天 年份</span></div><div class="line">            timeStr = str(currenYear) + <span class="string">'年'</span> + timeStr</div><div class="line">        timeStr = timeStr.replace(<span class="string">'年'</span>,<span class="string">'-'</span>)</div><div class="line">        timeStr = timeStr.replace(<span class="string">'月'</span>,<span class="string">'-'</span>)</div><div class="line">        timeStr = timeStr.replace(<span class="string">'日'</span>,<span class="string">''</span>)</div><div class="line"></div><div class="line">        colonArray = timeStr.split(<span class="string">':'</span>)</div><div class="line">        <span class="keyword">if</span> len(colonArray) == <span class="number">2</span>:</div><div class="line">            timeStr = timeStr + <span class="string">':00'</span></div><div class="line"></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            weiboCreateTimeArray = time.strptime(timeStr, <span class="string">"%Y-%m-%d %H:%M:%S"</span>)</div><div class="line">        </div><div class="line">            createdTimestamp = int(time.mktime(weiboCreateTimeArray))</div><div class="line">            print(<span class="string">"timeStr:"</span>,timeStr)</div><div class="line">            print(<span class="string">'createdTimestamp:'</span>,str(createdTimestamp))</div><div class="line">            print(<span class="string">'yesterdayStartTimeStamp:'</span>,str(yesterdayStartTimeStamp),<span class="string">' yesterdayEndTimeStamp:'</span>,str(yesterdayEndTimeStamp))</div><div class="line">            <span class="keyword">if</span> createdTimestamp &gt; yesterdayEndTimeStamp:</div><div class="line">                <span class="keyword">continue</span></div><div class="line">            <span class="keyword">if</span> createdTimestamp &lt; yesterdayStartTimeStamp:</div><div class="line">                <span class="keyword">return</span></div><div class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> err:</div><div class="line">            print(<span class="string">"timeStr:"</span>,timeStr)</div><div class="line">            print(err)</div><div class="line">            <span class="keyword">continue</span></div><div class="line">    </div><div class="line">        <span class="comment"># 微博的转发数量</span></div><div class="line">        repostCountStr = <span class="string">'0'</span></div><div class="line">        repostItems = cardElement.find_all(<span class="string">'a'</span>,&#123;<span class="string">'href'</span>: re.compile(<span class="string">'http://weibo.cn/repost/*'</span>)&#125;)</div><div class="line">        <span class="keyword">for</span> repost <span class="keyword">in</span> repostItems:</div><div class="line">            repostCountLongStr = repost.get_text()</div><div class="line">            repostCountStr = repostCountLongStr[<span class="number">3</span>:len(repostCountLongStr) - <span class="number">1</span>]</div><div class="line">            print(<span class="string">'转发数量:'</span>,repostCountStr,<span class="string">'\n\n'</span>)</div><div class="line"></div><div class="line">        </div><div class="line">        <span class="comment"># 转发微博的转发数量</span></div><div class="line">        repostWeiboRepostCountStr = <span class="string">'0'</span></div><div class="line">        <span class="keyword">for</span> i,cmt <span class="keyword">in</span> enumerate(cardElement.find_all(<span class="string">"span"</span>,&#123;<span class="string">"class"</span>:<span class="string">"cmt"</span>&#125;)):</div><div class="line">            <span class="keyword">if</span> i == <span class="number">2</span>:</div><div class="line">                repostWeiboRepostCountLongStr = cmt.get_text()</div><div class="line">                repostWeiboRepostCountStr = repostWeiboRepostCountLongStr[<span class="number">5</span>:len(repostWeiboRepostCountLongStr) - <span class="number">1</span>]</div><div class="line">                print(<span class="string">'转发微博的转发数量:'</span>,repostWeiboRepostCountStr,<span class="string">'\n\n'</span>)</div><div class="line"></div><div class="line">        <span class="keyword">if</span> int(repostCountStr) + int(repostWeiboRepostCountStr) &lt; <span class="number">20</span>:</div><div class="line">            <span class="keyword">continue</span></div><div class="line"></div><div class="line">        <span class="comment"># 微博内容</span></div><div class="line">        weiboContent = <span class="string">""</span></div><div class="line">        haveRetweetWeibo = <span class="keyword">False</span></div><div class="line">        <span class="keyword">if</span> len(cardElement.find_all(text=<span class="string">'转发理由:'</span>)) != <span class="number">0</span>:</div><div class="line">            haveRetweetWeibo = <span class="keyword">True</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> haveRetweetWeibo: <span class="comment"># 有转发微博</span></div><div class="line">            repostReasonItems = cardElement.find_all(<span class="string">'a'</span>,&#123;<span class="string">'href'</span>: re.compile(<span class="string">'http://weibo.cn/attitude/*'</span>)&#125;)[<span class="number">0</span>].previous_siblings;</div><div class="line">            <span class="keyword">for</span> index,repostReasonItem <span class="keyword">in</span> enumerate(repostReasonItems): <span class="comment"># 需要反向拼接</span></div><div class="line">                weiboContent = repostReasonItem.string + weiboContent;</div><div class="line">            weiboContent = weiboContent[<span class="number">5</span>:]</div><div class="line"></div><div class="line">            weiboContent = weiboContent + <span class="string">'\n\n'</span> + str(cardElement.find(<span class="string">"span"</span>,&#123;<span class="string">"class"</span>:<span class="string">"ctt"</span>&#125;))</div><div class="line">        <span class="keyword">else</span>: <span class="comment"># 没有转发微博</span></div><div class="line">            weiboContent = str(cardElement.find(<span class="string">"span"</span>,&#123;<span class="string">"class"</span>:<span class="string">"ctt"</span>&#125;))</div><div class="line"></div><div class="line">        <span class="comment"># 原文链接</span></div><div class="line">        weiboURL = <span class="string">""</span></div><div class="line">        <span class="keyword">for</span> ccA <span class="keyword">in</span> cardElement.find_all(<span class="string">"a"</span>,&#123;<span class="string">"class"</span>:<span class="string">"cc"</span>&#125;):</div><div class="line">            weiboURL = ccA[<span class="string">"href"</span>]</div><div class="line"></div><div class="line">        url1 = weiboURL.replace(<span class="string">'weibo.cn'</span>,<span class="string">'m.weibo.cn'</span>)</div><div class="line">        url1Array = url1.split(<span class="string">'='</span>)</div><div class="line">        uidArray = url1Array[<span class="number">1</span>].split(<span class="string">'&amp;'</span>)</div><div class="line">        uid = uidArray[<span class="number">0</span>]</div><div class="line">        weiboURL = url1.replace(<span class="string">'comment'</span>,uid)</div><div class="line">        weiboURL = re.sub(<span class="string">r'\?uid[\s\S]*'</span>,<span class="string">''</span>,weiboURL)</div><div class="line"></div><div class="line">        weiboIndex += <span class="number">1</span></div><div class="line">        mdContent = mdContent + <span class="string">'## '</span> +str(weiboIndex) + <span class="string">'.'</span> + weiboContent + <span class="string">'\n\n'</span> + <span class="string">'&lt;'</span> + weiboURL + <span class="string">'&gt;\n\n'</span> + timeStr + <span class="string">'\n\n'</span></div><div class="line"></div><div class="line">    pageIndex += <span class="number">1</span></div><div class="line">    getWeibo(userWeiboID,pageIndex)</div><div class="line"></div><div class="line"><span class="keyword">for</span> day <span class="keyword">in</span> range(<span class="number">1</span>):</div><div class="line">    structTime = time.localtime(time.time())</div><div class="line">    yesterdayCurrentTime = datetime.datetime.now() - datetime.timedelta(days=day+<span class="number">1</span>)</div><div class="line">    yesterdayStructTime = yesterdayCurrentTime.timetuple()</div><div class="line">    </div><div class="line">    yesterdayYear = yesterdayStructTime.tm_year</div><div class="line">    yesterdayMonth = yesterdayStructTime.tm_mon</div><div class="line">    yesterdayDay = yesterdayStructTime.tm_mday</div><div class="line">    </div><div class="line">    yesterdayStartTime = <span class="string">"%d-%d-%d 00:00:00"</span>%(yesterdayYear, yesterdayMonth, yesterdayDay)</div><div class="line">    yesterdayStartTimeArray = time.strptime(yesterdayStartTime, <span class="string">"%Y-%m-%d %H:%M:%S"</span>)</div><div class="line">    </div><div class="line">    yesterdayStartTimeStamp = int(time.mktime(yesterdayStartTimeArray))</div><div class="line">    </div><div class="line">    yesterdayEndTime = <span class="string">"%d-%d-%d 23:59:59"</span>%(yesterdayYear, yesterdayMonth, yesterdayDay)</div><div class="line">    yesterdayEndTimeArray = time.strptime(yesterdayEndTime, <span class="string">"%Y-%m-%d %H:%M:%S"</span>)</div><div class="line">    </div><div class="line">    yesterdayEndTimeStamp = int(time.mktime(yesterdayEndTimeArray))</div><div class="line">    </div><div class="line">    weiboIndex = <span class="number">0</span>;</div><div class="line">    </div><div class="line">    fileName = str(yesterdayYear) + <span class="string">"-"</span> + str(yesterdayMonth) + <span class="string">'-'</span> + str(yesterdayDay)</div><div class="line">    mdContent = <span class="string">'# '</span> + fileName + <span class="string">'\n\n'</span></div><div class="line">    </div><div class="line">    userWeiboDic = &#123;</div><div class="line">        <span class="string">"唐巧_boy"</span> : <span class="string">"1708947107"</span>,</div><div class="line">        <span class="string">"onevcat"</span> : <span class="string">"2210132365"</span>,</div><div class="line">        <span class="string">"iOS程序犭袁"</span> : <span class="string">"1692391497"</span>,</div><div class="line">        <span class="string">"没故事的卓同学"</span> : <span class="string">"1926303682"</span>,</div><div class="line">        <span class="string">"叶孤城___"</span> : <span class="string">"1438670852"</span>,</div><div class="line">        <span class="string">"我就叫Sunny怎么了"</span> : <span class="string">"1364395395"</span>,</div><div class="line">        <span class="string">"nixzhu"</span> : <span class="string">"2076580237"</span>,</div><div class="line">        <span class="string">"ibireme"</span> : <span class="string">"2477831984"</span>,</div><div class="line">        <span class="string">"bang"</span> : <span class="string">"1642409481"</span>,</div><div class="line">        <span class="string">"KITTEN-YANG"</span> : <span class="string">"2854163804"</span>,</div><div class="line">        <span class="string">"StackOverflowError"</span> : <span class="string">"1765732340"</span>,</div><div class="line">        <span class="string">"图拉鼎"</span> : <span class="string">"1846569133"</span>,</div><div class="line">        <span class="string">"lzwjava"</span> : <span class="string">"1695406573"</span>,</div><div class="line">        <span class="string">"董宝君_iOS"</span> : <span class="string">"3026163601"</span>,</div><div class="line">        <span class="string">"移动开发前线"</span> : <span class="string">"5861126740"</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">for</span> name,weiboID <span class="keyword">in</span> userWeiboDic.items():</div><div class="line">        print(<span class="string">"-------正在爬取 %s 的微博------"</span>%name)</div><div class="line">        getWeibo(weiboID,<span class="number">1</span>)</div><div class="line"></div><div class="line">    filePath = <span class="string">'./notes/'</span> + fileName + <span class="string">'.md'</span></div><div class="line">    print(<span class="string">'filePath:'</span>,filePath,<span class="string">'mdContent:'</span>,mdContent)</div><div class="line">    f = open(filePath,mode=<span class="string">'w'</span>,encoding=<span class="string">"UTF-8"</span>)</div><div class="line">    f.write(mdContent)</div><div class="line">    f.close()</div><div class="line"></div><div class="line">print(<span class="string">'爬取完毕'</span>)</div></pre></td></tr></table></figure>
<p>爬取结果如下：</p>
<p><img src="/images/weibo_spider/3.png" alt="微博爬虫"></p>
<p>未完待续 ……</p>
<p>后续功能：</p>
<ul>
<li>将数据存入数据库</li>
<li>生成邮件模板</li>
<li>定时任务。定时抓取，定时发送邮件</li>
<li>自动读取 Chrome 里 Cookie</li>
<li>使用更高级的第三方库</li>
<li>使用 Scrap 爬虫</li>
</ul>
</div></article></div></section><footer><div class="paginator"><a href="/2016/08/21/一个猿的自娱自乐/" class="next">下一篇</a></div><div data-thread-key="2016/10/30/每日爬取技术大牛微博生成Markdown/" data-title="每日爬取技术大牛微博生成 Markdown" data-url="http://iYiming.me/2016/10/30/每日爬取技术大牛微博生成Markdown/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"jiajiayouba"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2014 - 2016 <a href="http://iYiming.me">iYiming</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1253468447'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s6.cnzz.com/z_stat.php%3Fid%3D1253468447%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?3cec0b24b46b86302d1aa3b050d4668f";var s = document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm, s);})();</script></body></html>