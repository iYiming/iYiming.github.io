<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 每日爬取技术大牛微博生成邮件（一） · 一鸣的博客</title><meta name="description" content="Python"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.jpg"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://iYiming.me/atom.xml" title="一鸣的博客"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/jiajiayouba" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/iYiming" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">每日爬取技术大牛微博生成邮件（一）</h1><div class="post-info">2016年10月30日</div><div class="post-content"><p>一年前，自己开通了公众号，将每天微博上最新的 iOS 技术文章，制作成笔记的形式分享出来。持续了一年时间，最近因为创业，已经好些天没有更新了。最近有人向我反馈这个问题，我也拿比较忙没有时间推脱。</p>
<p>随着问的人越来越多，开始思考，怎么用技术的手段自动化生成这些笔记,想到前段时间学习到的 Python，想利用爬虫来解决这个问题。</p>
<a id="more"></a>
<p>爬取步骤：  </p>
<ol>
<li>分析微博网站。找到获取某个用户微博数据的 URL。</li>
<li>通过 URL 获取到微博内容。ID、微博内容、转发内容、时间等。</li>
<li>清洗数据。数据爬取出来可能有杂质，比如带有 HTML 标签，需要清洗数据。</li>
<li>将数据存入数据库</li>
<li>每天 8:00 从数据库中取出数据，并生成带有格式的邮件。 </li>
</ol>
<h1 id="分析微博网站"><a href="#分析微博网站" class="headerlink" title="分析微博网站"></a>分析微博网站</h1><p><a href="http://m.weibo.cn/page/json?containerid=1005052088894917_-_WEIBO_SECOND_PROFILE_WEIBO&amp;page=1" target="_blank" rel="external">http://m.weibo.cn/page/json?containerid=1005052088894917_-_WEIBO_SECOND_PROFILE_WEIBO&amp;page=1</a></p>
<h1 id="获取数据"><a href="#获取数据" class="headerlink" title="获取数据"></a>获取数据</h1><p>因为上面的链接返回的是 JSON 数据，不是 HTML 数据，这样大大减少了爬取的难度。数据格式如下（做了处理，仅列出一条微博的结构）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;card_type&quot;: 9,</div><div class="line">    &quot;mblog&quot;: &#123;</div><div class="line">        &quot;created_at&quot;: &quot;1分钟前&quot;,</div><div class="line">        &quot;id&quot;: 4036329354589998,</div><div class="line">        &quot;mid&quot;: &quot;4036329354589998&quot;,</div><div class="line">        &quot;idstr&quot;: &quot;4036329354589998&quot;,</div><div class="line">        &quot;text&quot;: &quot;转发微博&quot;,</div><div class="line">        &quot;source_allowclick&quot;: 0,</div><div class="line">        &quot;source_type&quot;: 1,</div><div class="line">        &quot;source&quot;: &quot;iPhone 6 Plus&quot;,</div><div class="line">        &quot;appid&quot;: 1370926,</div><div class="line">        &quot;favorited&quot;: false,</div><div class="line">        &quot;pic_ids&quot;: [],</div><div class="line">        &quot;user&quot;: &#123;</div><div class="line">            &quot;id&quot;: 2088894917,</div><div class="line">            &quot;screen_name&quot;: &quot;iYiming&quot;,</div><div class="line">            &quot;profile_image_url&quot;: &quot;http://tva2.sinaimg.cn/crop.0.0.908.908.180/7c8201c5jw8enyqfi4y8ej20p80p8gn8.jpg&quot;,</div><div class="line">            &quot;profile_url&quot;: &quot;/u/2088894917&quot;,</div><div class="line">            &quot;statuses_count&quot;: 4495,</div><div class="line">            &quot;verified&quot;: false,</div><div class="line">            &quot;verified_reason&quot;: &quot;&quot;,</div><div class="line">            &quot;description&quot;: &quot;越努力 越幸运！&quot;,</div><div class="line">            &quot;remark&quot;: &quot;&quot;,</div><div class="line">            &quot;verified_type&quot;: -1,</div><div class="line">            &quot;gender&quot;: &quot;m&quot;,</div><div class="line">            &quot;mbtype&quot;: 0,</div><div class="line">            &quot;h5icon&quot;: &#123;</div><div class="line">                &quot;main&quot;: 0,</div><div class="line">                &quot;other&quot;: []</div><div class="line">            &#125;,</div><div class="line">            &quot;ismember&quot;: 0,</div><div class="line">            &quot;valid&quot;: null,</div><div class="line">            &quot;fansNum&quot;: 134,</div><div class="line">            &quot;follow_me&quot;: false,</div><div class="line">            &quot;following&quot;: false</div><div class="line">        &#125;,</div><div class="line">        &quot;retweeted_status&quot;: &#123;</div><div class="line">            &quot;created_at&quot;: &quot;今天 02:34&quot;,</div><div class="line">            &quot;id&quot;: 4036105911562416,</div><div class="line">            &quot;mid&quot;: &quot;4036105911562416&quot;,</div><div class="line">            &quot;idstr&quot;: &quot;4036105911562416&quot;,</div><div class="line">            &quot;text&quot;: &quot;我写了新文章《2016年末闲谈iOS开发的未来》（ 分享自 &lt;a href=&apos;/n/简书&apos;&gt;@简书&lt;/a&gt; ） &lt;a data-url=\&quot;http://t.cn/RVmxjs7\&quot; href=\&quot;http://media.weibo.cn/article?id=2309614036183188449410&amp;object_id=1022%3A2309614036183188449410&amp;url_type=39&amp;object_type=article&amp;pos=1&amp;containerid=&amp;\&quot; &gt;&lt;i class=\&quot;iconimg iconimg-xs\&quot;&gt;&lt;img src=\&quot;http://h5.sinaimg.cn/upload/2015/09/25/3/timeline_card_small_article_default.png\&quot;&gt;&lt;/i&gt;&lt;span class=\&quot;surl-text\&quot;&gt;2016年末闲谈iO...&lt;/span&gt;&lt;/a&gt;&quot;,</div><div class="line">            &quot;textLength&quot;: 79,</div><div class="line">            &quot;source_allowclick&quot;: 0,</div><div class="line">            &quot;source_type&quot;: 1,</div><div class="line">            &quot;source&quot;: &quot;简书&quot;,</div><div class="line">            &quot;appid&quot;: 623636,</div><div class="line">            &quot;favorited&quot;: false,</div><div class="line">            &quot;pic_ids&quot;: [</div><div class="line">                &quot;72d10fc2jw1f99ph0z9v7j20hs8tbb13&quot;</div><div class="line">            ],</div><div class="line">            &quot;thumbnail_pic&quot;: &quot;http://ww4.sinaimg.cn/thumbnail/72d10fc2jw1f99ph0z9v7j20hs8tbb13.jpg&quot;,</div><div class="line">            &quot;bmiddle_pic&quot;: &quot;http://ww4.sinaimg.cn/bmiddle/72d10fc2jw1f99ph0z9v7j20hs8tbb13.jpg&quot;,</div><div class="line">            &quot;original_pic&quot;: &quot;http://ww4.sinaimg.cn/large/72d10fc2jw1f99ph0z9v7j20hs8tbb13.jpg&quot;,</div><div class="line">            &quot;user&quot;: &#123;</div><div class="line">                &quot;id&quot;: 1926303682,</div><div class="line">                &quot;screen_name&quot;: &quot;没故事的卓同学&quot;,</div><div class="line">                &quot;profile_image_url&quot;: &quot;http://tva4.sinaimg.cn/crop.0.0.750.750.180/72d10fc2jw8f8r4qjeggej20ku0kuwew.jpg&quot;,</div><div class="line">                &quot;profile_url&quot;: &quot;/u/1926303682&quot;,</div><div class="line">                &quot;statuses_count&quot;: 702,</div><div class="line">                &quot;verified&quot;: true,</div><div class="line">                &quot;verified_reason&quot;: &quot;简书推荐作者&quot;,</div><div class="line">                &quot;description&quot;: &quot;一个脱离了高级趣味的iOS伪摇程序员。&quot;,</div><div class="line">                &quot;remark&quot;: &quot;&quot;,</div><div class="line">                &quot;verified_type&quot;: 0,</div><div class="line">                &quot;gender&quot;: &quot;m&quot;,</div><div class="line">                &quot;mbtype&quot;: 11,</div><div class="line">                &quot;h5icon&quot;: &#123;</div><div class="line">                    &quot;main&quot;: &quot;http://u1.sinaimg.cn/upload/2013/02/22/v_yellow_2x.png&quot;,</div><div class="line">                    &quot;other&quot;: [</div><div class="line">                        &quot;http://u1.sinaimg.cn/upload/2013/01/23/crown_2x.png&quot;</div><div class="line">                    ]</div><div class="line">                &#125;,</div><div class="line">                &quot;ismember&quot;: 1,</div><div class="line">                &quot;valid&quot;: null,</div><div class="line">                &quot;fansNum&quot;: 2869,</div><div class="line">                &quot;follow_me&quot;: false,</div><div class="line">                &quot;following&quot;: true</div><div class="line">            &#125;,</div><div class="line">            &quot;reposts_count&quot;: 145,</div><div class="line">            &quot;comments_count&quot;: 24,</div><div class="line">            &quot;attitudes_count&quot;: 34,</div><div class="line">            &quot;isLongText&quot;: false,</div><div class="line">            &quot;mlevel&quot;: 0,</div><div class="line">            &quot;visible&quot;: &#123;</div><div class="line">                &quot;type&quot;: 0,</div><div class="line">                &quot;list_id&quot;: 0</div><div class="line">            &#125;,</div><div class="line">            &quot;biz_ids&quot;: [</div><div class="line">                0</div><div class="line">            ],</div><div class="line">            &quot;biz_feature&quot;: 0,</div><div class="line">            &quot;hasActionTypeCard&quot;: 1,</div><div class="line">            &quot;hot_weibo_tags&quot;: [],</div><div class="line">            &quot;text_tag_tips&quot;: [],</div><div class="line">            &quot;userType&quot;: 0,</div><div class="line">            &quot;cardid&quot;: &quot;vip_002&quot;,</div><div class="line">            &quot;positive_recom_flag&quot;: 0,</div><div class="line">            &quot;gif_ids&quot;: &quot;&quot;,</div><div class="line">            &quot;is_show_bulletin&quot;: 2,</div><div class="line">            &quot;page_info&quot;: &#123;</div><div class="line">                &quot;type&quot;: 2,</div><div class="line">                &quot;page_pic&quot;: &quot;http://tc.sinaimg.cn/maxwidth.2048/tc.service.weibo.com/upload_images_jianshu_io/db3d4e27e4392f74c223bb1981b8716c.png&quot;,</div><div class="line">                &quot;page_id&quot;: &quot;2309614036183188449410&quot;,</div><div class="line">                &quot;page_title&quot;: &quot;2016年末闲谈iOS开发的未来&quot;,</div><div class="line">                &quot;type_icon&quot;: &quot;http://u1.sinaimg.cn/upload/2014/03/20/61020.png&quot;,</div><div class="line">                &quot;content1&quot;: &quot;2016年末闲谈iOS开发的未来&quot;,</div><div class="line">                &quot;content2&quot;: &quot;&quot;,</div><div class="line">                &quot;preload&quot;: true,</div><div class="line">                &quot;page_url&quot;: &quot;http://media.weibo.cn/article?id=2309614036183188449410&amp;object_id=1022%3A2309614036183188449410&amp;url_type=39&amp;object_type=article&amp;pos=2&amp;containerid=&amp;&quot;,</div><div class="line">                &quot;actionlog&quot;: &#123;</div><div class="line">                    &quot;source&quot;: &quot;article&quot;,</div><div class="line">                    &quot;act_code&quot;: 1423,</div><div class="line">                    &quot;cardid&quot;: &quot;&quot;,</div><div class="line">                    &quot;lcardid&quot;: &quot;&quot;,</div><div class="line">                    &quot;uicode&quot;: &quot;&quot;,</div><div class="line">                    &quot;luicode&quot;: &quot;&quot;,</div><div class="line">                    &quot;fid&quot;: &quot;&quot;,</div><div class="line">                    &quot;lfid&quot;: &quot;&quot;,</div><div class="line">                    &quot;fromlog&quot;: &quot;&quot;,</div><div class="line">                    &quot;ext&quot;: &quot;uid:2088894917|mid:4036329354589998|rootuid:1926303682|rootmid:4036105911562416|objectid:1022:2309614036183188449410&quot;</div><div class="line">                &#125;,</div><div class="line">                &quot;page_desc&quot;: &quot;&quot;</div><div class="line">            &#125;,</div><div class="line">            &quot;created_timestamp&quot;: 1477766099,</div><div class="line">            &quot;bid&quot;: &quot;Ef9hl6ysg&quot;,</div><div class="line">            &quot;pics&quot;: [</div><div class="line">                &#123;</div><div class="line">                    &quot;pid&quot;: &quot;72d10fc2jw1f99ph0z9v7j20hs8tbb13&quot;,</div><div class="line">                    &quot;url&quot;: &quot;http://ww4.sinaimg.cn/wap180/72d10fc2jw1f99ph0z9v7j20hs8tbb13.jpg&quot;,</div><div class="line">                    &quot;size&quot;: &quot;wap180&quot;,</div><div class="line">                    &quot;geo&quot;: &#123;</div><div class="line">                        &quot;width&quot;: 54,</div><div class="line">                        &quot;height&quot;: 180,</div><div class="line">                        &quot;croped&quot;: true,</div><div class="line">                        &quot;byte&quot;: 1006871</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            ],</div><div class="line">            &quot;like_count&quot;: 34,</div><div class="line">            &quot;attitudes_status&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &quot;reposts_count&quot;: 0,</div><div class="line">        &quot;comments_count&quot;: 0,</div><div class="line">        &quot;attitudes_count&quot;: 0,</div><div class="line">        &quot;isLongText&quot;: false,</div><div class="line">        &quot;mlevel&quot;: 0,</div><div class="line">        &quot;visible&quot;: &#123;</div><div class="line">            &quot;type&quot;: 0,</div><div class="line">            &quot;list_id&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &quot;biz_feature&quot;: 0,</div><div class="line">        &quot;hasActionTypeCard&quot;: 0,</div><div class="line">        &quot;hot_weibo_tags&quot;: [],</div><div class="line">        &quot;text_tag_tips&quot;: [],</div><div class="line">        &quot;userType&quot;: 0,</div><div class="line">        &quot;positive_recom_flag&quot;: 0,</div><div class="line">        &quot;gif_ids&quot;: &quot;&quot;,</div><div class="line">        &quot;is_show_bulletin&quot;: 2,</div><div class="line">        &quot;mblogtype&quot;: 0,</div><div class="line">        &quot;url_struct&quot;: [</div><div class="line">            &#123;</div><div class="line">                &quot;url_title&quot;: &quot;2016年末闲谈iOS开发的未来&quot;,</div><div class="line">                &quot;url_type_pic&quot;: &quot;http://h5.sinaimg.cn/upload/2015/09/25/3/timeline_card_small_article.png&quot;,</div><div class="line">                &quot;ori_url&quot;: &quot;sinaweibo://article?object_id=1022:2309614036183188449410&amp;url_type=39&amp;object_type=article&amp;pos=1&quot;,</div><div class="line">                &quot;page_id&quot;: &quot;2309614036183188449410&quot;,</div><div class="line">                &quot;short_url&quot;: &quot;http://t.cn/RVmxjs7&quot;,</div><div class="line">                &quot;url_type&quot;: 39,</div><div class="line">                &quot;result&quot;: true,</div><div class="line">                &quot;actionlog&quot;: &#123;</div><div class="line">                    &quot;source&quot;: &quot;article&quot;,</div><div class="line">                    &quot;act_code&quot;: 1423,</div><div class="line">                    &quot;cardid&quot;: &quot;&quot;,</div><div class="line">                    &quot;lcardid&quot;: &quot;&quot;,</div><div class="line">                    &quot;uicode&quot;: &quot;&quot;,</div><div class="line">                    &quot;luicode&quot;: &quot;&quot;,</div><div class="line">                    &quot;fid&quot;: &quot;&quot;,</div><div class="line">                    &quot;lfid&quot;: &quot;&quot;,</div><div class="line">                    &quot;fromlog&quot;: &quot;&quot;,</div><div class="line">                    &quot;ext&quot;: &quot;uid:2088894917|mid:4036329354589998|rootuid:1926303682|rootmid:4036105911562416|objectid:1022:2309614036183188449410&quot;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        ],</div><div class="line">        &quot;created_timestamp&quot;: 1477819372,</div><div class="line">        &quot;bid&quot;: &quot;Eff5Jjg4e&quot;,</div><div class="line">        &quot;like_count&quot;: 0,</div><div class="line">        &quot;attitudes_status&quot;: 0</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过上面的数据结构，很容易找到想要获取的数据：</p>
<ul>
<li>微博 ID</li>
<li>微博内容</li>
<li>微博创建时间</li>
<li>被转发的微博内容</li>
<li>被转发的微博创建时间</li>
<li>微博内容里文章链接地址</li>
<li>微博原始 URL 地址（这个在从上面 JSON 里看不出来，后续会介绍）</li>
</ul>
<p>通过上面的数据，获得一个叫 mblog 字段，这里把它描述成一个对象 weibo，那么上面要获取的数据为(伪代码)：</p>
<p>微博 ID ：weibo.id<br>微博内容 ：weibo.text<br>微博创建时间：weibo.created_at<br>被转发的微博内容：weibo.retweeted_status.text<br>被转发的微博创建时间：weibo.retweeted_status.created_at<br>微博内容里文章链接地址：weibo.retweeted_status.text 里获得<br>微博原始 URL 地址：</p>
<p>通过微博客服端找到微博详情，地址如下：</p>
<p><a href="http://weibo.com/5861126740/EewuvDAEv" target="_blank" rel="external">http://weibo.com/5861126740/EewuvDAEv</a></p>
<p>简化成：</p>
<p><a href="http://weibo.com/XXXX/XXXX" target="_blank" rel="external">http://weibo.com/XXXX/XXXX</a></p>
<p>第一个 XXXX 很明显是当前微博发布者的 ID<br>第二个 XXXX 看例子中的 <code>EewuvDAEv</code> 和 JSON 数据结构的 <code>bid</code> 差不多，经过测试，果真就是这个。</p>
<p>OK 到这里就差一个程序猿敲代码了。</p>
<p>我们使用 Python 3 作为我们的程序语言，然后使用哪些库呢？</p>
<ol>
<li>要获取 <a href="http://m.weibo.cn/page/json?containerid=1005052088894917_-_WEIBO_SECOND_PROFILE_WEIBO&amp;page=1" target="_blank" rel="external">http://m.weibo.cn/page/json?containerid=1005052088894917_-_WEIBO_SECOND_PROFILE_WEIBO&amp;page=1</a> 里面的数据，我们得使用 urllib 库</li>
<li>要抓取 JSON 数据，我们得使用 json 库</li>
<li>微博内容里文章链接地址要从 <code>weibo.retweeted_status.text</code> 里获得，通过分析发现他在 <code>a</code> 标签里的 <figure class="highlight plain"><figcaption><span>下，这里我们用到 BeautifulSoup 第三方库，上面的那两个库都是系统自带的，BeautifulSoup 库需要自己安装。</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#### 获取微博数据</div><div class="line"></div><div class="line">通过多次测试，发现有时直接调用上面的链接，有时会不稳定。还是在 header 里添加上 Cookie 吧，这样就能真实模拟浏览器了。</div></pre></td></tr></table></figure></li>
</ol>
<p>from urllib.request import urlopen<br>from urllib.request import Request</p>
<p>url = “<a href="http://m.weibo.cn/page/json?containerid=1005052088894917_-_WEIBO_SECOND_PROFILE_WEIBO&amp;page=1" target="_blank" rel="external">http://m.weibo.cn/page/json?containerid=1005052088894917_-_WEIBO_SECOND_PROFILE_WEIBO&amp;page=1</a>“</p>
<p>header = {<br>            “User-Agent” : “Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/54.0.2840.71 Safari/537.36”,<br>            “Connection” : “keep-alive”,<br>            “Cache-Control” : “max-age=0”,<br>            “Upgrade-Insecure-Requests” : “1”,<br>            “Accept” :”text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,<em>/</em>;q=0.8”,<br>            “Accept-Language”:”zh-CN,zh;q=0.8,en;q=0.6,zh-TW;q=0.4,ja;q=0.2”,<br>            “Cookie”: “这里填写你自己的 Cookie(下面有介绍，如何获取)”<br>}</p>
<p>request = Request(url,None,header)<br>response = urlopen(request,timeout=10)</p>
<p>print(response.read())<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">注：</div><div class="line"></div><div class="line">如何获取自己的 Cookie？</div><div class="line"></div><div class="line">- 先在 Chrome 浏览器里登录微博</div><div class="line">- 打开链接 &lt;http://m.weibo.cn/page/json?containerid=1005052088894917_-_WEIBO_SECOND_PROFILE_WEIBO&amp;page=1&gt;</div><div class="line">- cmd + option + i 打开开发者工具，找到上面链接，即可在 Header 里找到 Cookie，贴到上面就可以了。 </div><div class="line"></div><div class="line">#### 解析 JSON 数据</div><div class="line"></div><div class="line">引入 json 库，直接贴代码：</div></pre></td></tr></table></figure></p>
<p>import re</p>
<p>jsonObj = json.loads(response.read().decode(“utf-8”))<br>weibo = jsonObj.get(“mblog”) # 这里只是列出如何使用 json 库，并不是上面真实 JSON 数据<br>text = weibo.get(“text”)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#### 获取文章链接地址</div><div class="line"></div><div class="line">这里我们用到 BeautifulSoup 这个库,我们需要自己手动安装：</div><div class="line"></div><div class="line">1.创建虚拟环境并激活</div></pre></td></tr></table></figure></p>
<p>mkdir weibo<br>cd weibo<br>pyvenv venv<br>source venv/bin/activate<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">2.使用 pip 安装 BeautifulSoup</div></pre></td></tr></table></figure></p>
<p>pip install beautifulsoup4<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">3.在 weibo.py 里引入 BeautifulSoup</div></pre></td></tr></table></figure></p>
<p>from bs4 import BeautifulSoup<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">通过 ``weibo.get(&quot;text&quot;)`` 获取微博内容如下：</div></pre></td></tr></table></figure></p>
<p>我写了新文章《2016年末闲谈iOS开发的未来》（ 分享自 <a href="/n/简书">@简书</a> ） <a data-url="\"http://t.cn/RVmxjs7\"" href="\"http://media.weibo.cn/article?id=2309614036183188449410&object_id=1022%3A2309614036183188449410&url_type=39&object_type=article&pos=1&containerid=&\""><i class="\"iconimg" iconimg-xs\"=""><img src="\"http://h5.sinaimg.cn/upload/2015/09/25/3/timeline_card_small_article_default.png\""></i><span class="\"surl-text\"">2016年末闲谈iO…</span></a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">经过多次分析，a 标签里的 data-url 就是我们想要的数据，这个如何获得呢？</div></pre></td></tr></table></figure></p>
<p>from bs4 import BeautifulSoup</p>
<p>bsObj = BeautifulSoup(weiboContent,”html.parser”)<br>articleData = bsObj.find(“i”,{“class”:”iconimg iconimg-xs”}) # 微博中存在的文章链接<br>if articleData is not None:<br>    articleURL = articleData.parent.get(“data-url”)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">## 清洗数据</div><div class="line"></div><div class="line">要抓取的微博内容里（即 weibo.text 和 weibo.retweeted_status.text），有 HTML 标签，这个不需要，干掉。可以使用 正则表达式 来处理，得需要引入一个 re 系统库。</div><div class="line"></div><div class="line">因为每天抓取前一天的微博数据，其他数据不要，要进行时间比对。要引入 time 系统库。</div><div class="line"></div><div class="line">不是每条微博都要抓取，比如哪天大牛心情不好，发了一篇无关紧要的微博，这一条微博就不是我们想抓取的，这个怎么办？我这里做了个限制，只抓去 转发数 &gt;= 20 的微博，这样会去掉不少无关微博，即使抓取的微博不是技术相关的，也是可以看看的。</div><div class="line"></div><div class="line">#### 去掉 HTML 标签</div><div class="line"></div><div class="line">直接上代码：</div></pre></td></tr></table></figure></p>
<p>import re</p>
<p>weiboContent = mblog.get(“text”) # 微博内容<br>content = re.compile(r’&lt;[^&gt;]+&gt;’,re.S).sub(‘’, weiboContent)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#### 仅抓取昨日微博数据</div><div class="line"></div><div class="line">分析 JSON 里 ``created-at`` 字段，格式无非就是 </div><div class="line"></div><div class="line">- 几分钟前 </div><div class="line">- 几小时前 </div><div class="line">- 今天 18:30 </div><div class="line">- 10-27 21:27</div><div class="line">- 2015-10-22 12:28</div><div class="line"></div><div class="line">我们需要的仅是昨天的微博。</div></pre></td></tr></table></figure></p>
<p>import time</p>
<p>currentYear = time.localtime().tm_year<br>currentMonth = time.localtime().tm_mon<br>currentDay = time.localtime().tm_mday</p>
<h1 id="注意下方这段代码-是放在循环里面的"><a href="#注意下方这段代码-是放在循环里面的" class="headerlink" title="注意下方这段代码 是放在循环里面的"></a>注意下方这段代码 是放在循环里面的</h1><p>createdTime = mblog.get(“created_at”) # 微博创建时间<br>timeArray = createdTime.split()<br>if timeArray[0] == ‘今天’:<br>      continue<br>if len(timeArray) &lt;= 1:<br>      continue<br>yearMonthDayArray = timeArray[0].split(‘-‘)<br>yearStr = currentYear<br>monthStr = currentMonth<br>dayStr = currentDay<br>if len(yearMonthDayArray) == 3:<br>    yearStr = yearMonthDayArray[0]<br>else:<br>    monthStr = yearMonthDayArray[0]<br>    dayStr = yearMonthDayArray[1]</p>
<p>if int(yearStr) &lt; currentYear or int(monthStr) &lt; currentMonth or int(dayStr) &lt; currentDay - 1:<br>    return</p>
<p>if int(dayStr) != currentDay - 1:<br>     continue<br>else:<br>     continue</p>
<h1 id="下方处理的数据才是我们要的微博数据"><a href="#下方处理的数据才是我们要的微博数据" class="headerlink" title="下方处理的数据才是我们要的微博数据"></a>下方处理的数据才是我们要的微博数据</h1><p>weiboContent = mblog.get(“text”) # 微博内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#### 转发数 &gt; 20</div><div class="line"></div><div class="line">这里指的转发数是指 本条微博的转发数 + 本条微博所转发的原始微博的转发数，比较绕，请三思。</div></pre></td></tr></table></figure></p>
<p>weiboContent = mblog.get(“text”) # 微博内容<br>repostsCount = mblog.get(“reposts_count”) # 微博转发数量<br>retweeted_status = mblog.get(“retweeted_status”) # 转发的微博</p>
<p>if retweeted_status is not None: # 没有转发微博<br>    retweetedID = retweeted_status.get(“id”) # 转发的微博 ID<br>    retweetedOriginContent = retweeted_status.get(“text”) # 转发的微博内容<br>    retweetedWeiboRepostsCount = retweeted_status.get(“reposts_count”) # 转发的微博的转发数量</p>
<pre><code>if retweetedWeiboRepostsCount is  None or repostsCount is None:# 此微博可能已被删除 故做此判断
    continue

if retweetedWeiboRepostsCount + repostsCount &gt; 20:
        print(weiboContent,retweetedOriginContent)
else: # 原创微博
    if repostsCount is None: # 此微博可能已被删除 故做此判断
        continue

    if repostsCount &gt; 20:
        print(weiboContent)
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">## 源码</div></pre></td></tr></table></figure>
<p>from urllib.request import urlopen<br>from urllib.request import Request<br>import json<br>from bs4 import BeautifulSoup<br>import re<br>import time</p>
<p>def get<em>weibo(userWeiboID,pageIndex):<br>    url = “<a href="http://m.weibo.cn/page/json?containerid=%s" target="_blank" rel="external">http://m.weibo.cn/page/json?containerid=%s</a></em>-_WEIBO_SECOND_PROFILE_WEIBO&amp;page=%d”%(userWeiboID,pageIndex)</p>
<pre><code>print(&quot;----正在爬取第 %d 页----\n\n\n&quot;%pageIndex)

currentYear = time.localtime().tm_year
currentMonth = time.localtime().tm_mon
currentDay = time.localtime().tm_mday

yesterdayDateTime = &quot;%d-%d&quot;%(time.localtime().tm_mon,time.localtime().tm_mday - 1)

header = {
            &quot;User-Agent&quot; : &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/54.0.2840.71 Safari/537.36&quot;,
            &quot;Connection&quot; : &quot;keep-alive&quot;,
            &quot;Cache-Control&quot; : &quot;max-age=0&quot;,
            &quot;Upgrade-Insecure-Requests&quot; : &quot;1&quot;,
            &quot;Accept&quot; :&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8&quot;,
            &quot;Accept-Language&quot;:&quot;zh-CN,zh;q=0.8,en;q=0.6,zh-TW;q=0.4,ja;q=0.2&quot;,
&quot;Cookie&quot;: &quot;_T_WM=dbaad621dd1846fd781c9958764d220e; H5_INDEX=0_group_3708097111070440; H5_INDEX_TITLE=iOS%20; SCF=AkpePJEuaE7y2vvrVGRXREb_9cjezep8L95ecwWKmewzIoy1SsDq8Upor2Y5FlZpaJxRmaZ-5BUbFbtVG1QJxu4.; SUB=_2A251ELghDeTxGeRO41oZ-SrFyjuIHXVW-thprDV6PUJbktBeLVPekW1bU5KKH_5GviMU2hyWVEI8cHe97w..; SUBP=0033WrSXqPxfM725Ws9jqgMF55529P9D9W5D3A_Q263Kyv5Ypy03VBBn5JpX5oz75NHD95QEehnR1h.X1K2NWs4DqcjGIHLDdgLV97tt; SUHB=0gHzkJ_MiPKcAI; SSOLoginState=1477757041; ALF=1480349041&quot;
}
request = Request(url,None,header)
response = urlopen(request,timeout=10)

jsonObj = json.loads(response.read().decode(&quot;utf-8&quot;))

for cards in jsonObj.get(&quot;cards&quot;):
    card_group = cards.get(&quot;card_group&quot;)
    if card_group is None:
        get_weibo(userWeiboID,pageIndex)
        break

    for cardGroup in card_group:
        if cardGroup is None:
            get_weibo(userWeiboID,pageIndex)
            break

        mblog = cardGroup.get(&quot;mblog&quot;) # 微博
        mblogID = mblog.get(&quot;id&quot;) # 微博 ID
        originContent = mblog.get(&quot;text&quot;) # 微博 内容
        content = re.compile(r&apos;&lt;[^&gt;]+&gt;&apos;,re.S).sub(&apos;&apos;,originContent)
        createdTime = mblog.get(&quot;created_at&quot;) # 微博创建时间
        isTop = mblog.get(&quot;isTop&quot;) 
        timeArray = createdTime.split()
        if timeArray[0] == &apos;今天&apos;:
            continue
        if len(timeArray) &lt;= 1:
            continue
        yearMonthDayArray = timeArray[0].split(&apos;-&apos;)
        yearStr = currentYear
        monthStr = currentMonth
        dayStr = currentDay
        if len(yearMonthDayArray) == 3:
            yearStr = yearMonthDayArray[0]
        else:
            monthStr = yearMonthDayArray[0]
            dayStr = yearMonthDayArray[1]

        #print(&quot;year:&quot;,yearStr,&quot;month:&quot;,monthStr,&quot;day:&quot;,dayStr)
        if isTop is None:
            if int(yearStr) &lt; currentYear or int(monthStr) &lt; currentMonth or int(dayStr) &lt; currentDay - 1:
                return

            if int(dayStr) != currentDay - 1:
                continue
        else:
            continue


        repostsCount = mblog.get(&quot;reposts_count&quot;) # 微博转发数量
        bid = mblog.get(&quot;bid&quot;)
        retweeted_status = mblog.get(&quot;retweeted_status&quot;) # 转发的微博

        weiboURL = &quot;http://weibo.com/%s/%s&quot;%(userWeiboID[6:],bid)

        if retweeted_status is not None: # 没有转发微博
            retweetedID = retweeted_status.get(&quot;id&quot;) # 转发的微博 ID
            retweetedOriginContent = retweeted_status.get(&quot;text&quot;) # 转发的微博内容
            retweetedContent = re.compile(r&apos;&lt;[^&gt;]+&gt;&apos;,re.S).sub(&apos;&apos;,retweetedOriginContent)
            retweetedCreatedTime = retweeted_status.get(&quot;created_at&quot;) # 转发的微博创建时间
            retweetedWeiboRepostsCount = retweeted_status.get(&quot;reposts_count&quot;) # 转发的微博的转发数量

            if retweetedWeiboRepostsCount is  None or repostsCount is None:
                continue

            if retweetedWeiboRepostsCount + repostsCount &gt; 20:
                bsObj = BeautifulSoup(retweetedOriginContent,&quot;html.parser&quot;)
                articleData = bsObj.find(&quot;i&quot;,{&quot;class&quot;:&quot;iconimg iconimg-xs&quot;}) # 微博中存在的文章链接
                if articleData is not None:
                    articleURL = articleData.parent.get(&quot;data-url&quot;)
                    print(createdTime,&apos;\n\n&apos;,retweetedContent,&apos;\n\n&apos;,articleURL,&apos;\n\n&apos;,weiboURL,&apos;\n\n&apos;,retweetedCreatedTime,&quot;\n\n\n\n&quot;)
                else:
                    print(createdTime,&apos;\n\n&apos;,retweetedContent,&apos;\n\n&apos;,weiboURL,&apos;\n\n&apos;,retweetedCreatedTime,&quot;\n\n\n\n&quot;)

        else: #原创微博
            if repostsCount is None: # 此微博可能已被删除 故做此判断
                continue

            if repostsCount &gt; 20:
                bsObj = BeautifulSoup(originContent,&quot;html.parser&quot;)
                articleData = bsObj.find(&quot;i&quot;,{&quot;class&quot;:&quot;iconimg iconimg-xs&quot;})
                if articleData is not None:
                    articleURL = articleData.parent.get(&quot;data-url&quot;)
                    print(&quot;---原创微博---\n&quot;,createdTime,&apos;\n\n&apos;,content,&apos;\n\n&apos;,articleURL,&apos;\n\n&apos;,weiboURL,&quot;\n\n\n\n&quot;)
                else:
                    print(&quot;---原创微博---\n&quot;,createdTime,&apos;\n\n&apos;,content,&apos;\n\n&apos;,weiboURL,&quot;\n\n\n\n&quot;)

pageIndex = pageIndex + 1
get_weibo(userWeiboID,pageIndex)
</code></pre><p>userWeiboIDsArray = [<br>    “1005051708947107”, # 唐巧<em>boy<br>    “1005052210132365”, # onevcat<br>    “1005051692391497”, # iOS程序犭袁<br>    “1005051926303682”, # 没故事的卓同学<br>    “1005051438670852”, # 叶孤城__</em><br>    “1005051364395395”, # 我就叫Sunny怎么了<br>    “1005052076580237”, # nixzhu<br>    “1005052477831984”, # ibireme<br>    “1005051642409481”, # bang<br>    “1005052854163804”, # KITTEN-YANG<br>    “1005051765732340”, # StackOverflowError<br>    “1005051846569133”, # 图拉鼎<br>    “1005051695406573”, # lzwjava<br>    “1005053026163601”, # 董宝君_iOS<br>    “1005055861126740”, # 移动开发前线<br>    ]</p>
<p>for userWeiboID in userWeiboIDsArray:<br>    get_weibo(userWeiboID,1)<br>```</p>
<p>爬取结果：</p>
<p>未完待续 ……</p>
<p>后续功能：</p>
<ul>
<li>将数据存入数据库</li>
<li>生成邮件模板</li>
<li>定时任务。定时抓取，定时发送邮件</li>
<li>自动读取 Chrome 里 Cookie</li>
</ul>
</div></article></div></section><footer><div class="paginator"><a href="/2016/08/21/一个猿的自娱自乐/" class="next">下一篇</a></div><div data-thread-key="2016/10/30/每日爬取技术大牛微博生成邮件（一）/" data-title="每日爬取技术大牛微博生成邮件（一）" data-url="http://iYiming.me/2016/10/30/每日爬取技术大牛微博生成邮件（一）/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"jiajiayouba"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2014 - 2016 <a href="http://iYiming.me">iYiming</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1253468447'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s6.cnzz.com/z_stat.php%3Fid%3D1253468447%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?3cec0b24b46b86302d1aa3b050d4668f";var s = document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm, s);})();</script></body></html>