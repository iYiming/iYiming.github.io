<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> iOS SQLite 数据库迁移 · 一鸣的博客</title><meta name="description" content="iOS SQLite 数据库迁移 - iYiming"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.jpg"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://iYiming.me/atom.xml" title="一鸣的博客"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/jiajiayouba" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/iYiming" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">iOS SQLite 数据库迁移</h1><div class="post-info">2015年4月20日</div><div class="post-content"><p>最近不得不考虑关于数据库迁移的问题，原先用了种很不好的处理方式（每次版本升级就删除本地数据库，太傻），于是开始考虑下如何迁移数据库。</p>
<p>项目使用的 <a href="https://github.com/ccgus/fmdb" target="_blank" rel="external">FMDB</a>。在 <a href="https://github.com/ccgus/fmdb" target="_blank" rel="external">FMDB</a> 介绍页面，发现了 <a href="https://github.com/layerhq/FMDBMigrationManager" target="_blank" rel="external">FMDBMigrationManager</a> ，大喜。</p>
<p>看了半天文档，捣鼓了半天才弄出来，一步步整理下。</p>
<a id="more"></a>
<h2 id="安装-FMDBMigrationManager"><a href="#安装-FMDBMigrationManager" class="headerlink" title="安装 FMDBMigrationManager"></a>安装 FMDBMigrationManager</h2><p>Podfile 文件：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">platform :ios, "7.0"</div><div class="line"></div><div class="line">pod 'FMDB'</div><div class="line">pod 'FMDBMigrationManager'</div></pre></td></tr></table></figure>
<p>使用 <code>pod install</code> 命令安装</p>
<h2 id="FMDBMigrationManager-创建数据库"><a href="#FMDBMigrationManager-创建数据库" class="headerlink" title="FMDBMigrationManager 创建数据库"></a>FMDBMigrationManager 创建数据库</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">FMDBMigrationManager *manager = [FMDBMigrationManager managerWithDatabaseAtPath:[YMDatabaseHelper databasePath]  migrationsBundle:[NSBundle mainBundle]];</div></pre></td></tr></table></figure>
<p>其中<code>[YMDatabaseHelper databasePath]</code>是数据库路径</p>
<h2 id="创建迁移表"><a href="#创建迁移表" class="headerlink" title="创建迁移表"></a>创建迁移表</h2><p>创建的迁移表名称为：<code>schema_migrations</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[manager createMigrationsTable:&amp;error];</div></pre></td></tr></table></figure>
<h2 id="创建-sql-文件"><a href="#创建-sql-文件" class="headerlink" title="创建 .sql 文件"></a>创建 .sql 文件</h2><p>该文件用来存储每次升级使用的 SQL 语句。</p>
<p><code>FMDBMigrationManager</code> 建议我们使用时间戳来作为版本号，使用下面的命令生成一个文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">touch &quot;`ruby -e &quot;puts Time.now.strftime(&apos;%Y%m%d%H%M%S%3N&apos;).to_i&quot;`&quot;_CreateMyAwesomeTable.sql</div></pre></td></tr></table></figure>
<p>我生成的文件名为：<code>20150420170044940_CreateMyAwesomeTable.sql</code>,其中<code>20150420170044940</code> 为迁移的版本号标识。</p>
<p>我们在 <code>20150420170044940_CreateMyAwesomeTable.sql</code> 文件中创建一个用户表，写入：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">User</span>(</div><div class="line"><span class="keyword">id</span> <span class="built_in">INTEGER</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> PRIMARY <span class="keyword">KEY</span> AUTOINCREMENT,</div><div class="line"><span class="keyword">name</span> <span class="built_in">TEXT</span></div><div class="line">);</div></pre></td></tr></table></figure>
<h2 id="迁移函数"><a href="#迁移函数" class="headerlink" title="迁移函数"></a>迁移函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">FMDBMigrationManager *manager = [FMDBMigrationManager managerWithDatabaseAtPath:[YMDatabaseHelper databasePath]  migrationsBundle:[NSBundle mainBundle]];</div><div class="line"></div><div class="line">BOOL resultState = NO;</div><div class="line">NSError *error = nil;</div><div class="line"><span class="keyword">if</span> (!manager.hasMigrationsTable) &#123;</div><div class="line">resultState = [manager createMigrationsTable:&amp;error];</div><div class="line">&#125;</div><div class="line"></div><div class="line">resultState = [manager migrateDatabaseToVersion:UINT64_MAX progress:nil error:&amp;error];<span class="comment">//迁移函数</span></div><div class="line"></div><div class="line">NSLog(@<span class="string">"Has `schema_migrations` table?: %@"</span>, manager.hasMigrationsTable ? @<span class="string">"YES"</span> : @<span class="string">"NO"</span>);</div><div class="line">NSLog(@<span class="string">"Origin Version: %llu"</span>, manager.originVersion);</div><div class="line">NSLog(@<span class="string">"Current version: %llu"</span>, manager.currentVersion);</div><div class="line">NSLog(@<span class="string">"All migrations: %@"</span>, manager.migrations);</div><div class="line">NSLog(@<span class="string">"Applied versions: %@"</span>, manager.appliedVersions);</div><div class="line">NSLog(@<span class="string">"Pending versions: %@"</span>, manager.pendingVersions);</div></pre></td></tr></table></figure>
<p><code>UINT64_MAX</code> 表示把数据库迁移到最大的版本</p>
<p>运行项目，打印出如下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">2015-04-20 20:50:19.033 YMFMDatabase[12654:1326201] Has `schema_migrations` table?: YES</div><div class="line">2015-04-20 20:50:19.036 YMFMDatabase[12654:1326201] Origin Version: 20150420170044940</div><div class="line">2015-04-20 20:50:19.036 YMFMDatabase[12654:1326201] Current version: 20150420170044940</div><div class="line">2015-04-20 20:50:19.037 YMFMDatabase[12654:1326201] All migrations: (</div><div class="line">&quot;&lt;FMDBFileMigration: 0x17003b4c0&gt;&quot;</div><div class="line">)</div><div class="line">2015-04-20 20:50:19.037 YMFMDatabase[12654:1326201] Applied versions: (</div><div class="line">20150420170044940</div><div class="line">)</div><div class="line">2015-04-20 20:50:19.038 YMFMDatabase[12654:1326201] Pending versions: (</div><div class="line">)</div></pre></td></tr></table></figure>
<p>用 iFunBox 查看下是不是创建了一个 User 表，里面含有 <code>id</code> 、<code>name</code> 字段。以及 <code>FMDBMigrationManager</code> 生成的 <code>schema_migrations</code> 表。  </p>
<h2 id="创建第-2-个-sql-文件"><a href="#创建第-2-个-sql-文件" class="headerlink" title="创建第 2 个 .sql 文件"></a>创建第 2 个 .sql 文件</h2><p>先用上方命令: <code>touch &quot;`ruby -e &quot;puts Time.now.strftime(&#39;%Y%m%d%H%M%S%3N&#39;).to_i&quot;`&quot;_CreateMyAwesomeTable.sql</code> 生成,我生成的是： <code>20150420170557221_CreateMyAwesomeTable.sql</code> 。</p>
<p>第二个 sql 文件，里面创建一个新表名字为 Grouping ，为原先的 User 表添加邮箱字段：<code>email</code> 。.sql 文件修改如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">Grouping</span>(</div><div class="line"><span class="keyword">id</span> <span class="built_in">INTEGER</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> PRIMARY <span class="keyword">KEY</span> AUTOINCREMENT,</div><div class="line"><span class="keyword">name</span> <span class="built_in">TEXT</span></div><div class="line">);</div><div class="line"></div><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">User</span> <span class="keyword">ADD</span> email <span class="built_in">TEXT</span>;</div></pre></td></tr></table></figure>
<h2 id="创建第-3-个-sql-文件"><a href="#创建第-3-个-sql-文件" class="headerlink" title="创建第 3 个 .sql 文件"></a>创建第 3 个 .sql 文件</h2><p>生成同上，文件内容是为 Grouping 表添加备注字段 <code>remark</code> ：</p>
<p>文件内容：  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">Grouping</span> <span class="keyword">ADD</span> remark <span class="built_in">TEXT</span>;</div></pre></td></tr></table></figure>
<p>OK ，直接运行项目，看看是不是创建了 Grouping 表，里面含有 <code>id</code>, <code>name</code> , <code>remark</code> 字段，以及 User 表里面是不是添加了 <code>email</code> 字段。</p>
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><p>中间我自己做 Demo 时，试图删除表中的某列，比如删除 User 中的 <code>name</code> 列，但是不能成功，Google 了下发现<a href="http://stackoverflow.com/questions/8442147/how-to-delete-or-add-column-in-sqlite" target="_blank" rel="external">答案</a>。</p>
<blockquote>
<p>SQLite supports a limited subset of ALTER TABLE. The ALTER TABLE command in SQLite allows the user to rename a table or to add a new column to an existing table. It is not possible to rename a column, remove a column, or add or remove constraints from a table.</p>
</blockquote>
<p>就是说 SQLite 对 <code>ALERT TABLE</code> 命令受限制，SQLite 中的 <code>ALERT TABLE</code> 命令只能允许用户重命名表或者添加新列，不能重命名列或者删除列或者删除约束。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2015/05/17/watchkit-01/" class="prev">上一篇</a><a href="/2015/04/19/ios-mi-ma-cun-chu/" class="next">下一篇</a></div><div data-thread-key="2015/04/20/ios-sqlite_shu-ju-ku-qian-yi/" data-title="iOS SQLite 数据库迁移" data-url="http://iYiming.me/2015/04/20/ios-sqlite_shu-ju-ku-qian-yi/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"jiajiayouba"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2014 - 2017 <a href="http://iYiming.me">iYiming</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1253468447'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s6.cnzz.com/z_stat.php%3Fid%3D1253468447%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?3cec0b24b46b86302d1aa3b050d4668f";var s = document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm, s);})();</script></body></html>