<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Flask Web 开发学习笔记（六） · 一鸣的博客</title><meta name="description" content="Flask Web 开发学习笔记（六） - iYiming"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.jpg"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://iYiming.me/atom.xml" title="一鸣的博客"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/jiajiayouba" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/iYiming" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Flask Web 开发学习笔记（六）</h1><div class="post-info">2015年4月8日</div><div class="post-content"><p>本文主要介绍如何使用 Flask 操作数据库。</p>
<p>数据库按照一定规则保存程序数据，程序再发起查询取回所需的数据。Web 程序最常用基于关系模型的数据库，这种数据库也称为 SQL 数据，因为它们使用结构化查询语句。不过最近几年文档数据库和键值对数据库成了流行的替代选择，这两种数据库合称为 NoSQL 数据库。</p>
<p>大多数的数据库引擎都有对应的 Python 包，包括开源宝和商业包。Flask并不限制你使用何种类型的数据库包，因此可以根据自己的喜好选择使用 MySQL、Postgres、SQLite，Redis、MongoDB 或者 CouchDB。</p>
<p>如果这些都无法满足需求，还有一些数据库抽象层代码包供选择，例如 SQLAlchemy 和 MongoEngine 。你可以使用这些抽象包直接处理高等级的 Python 对象，而不用处理如表、文档或查询语言此类的数据库实体。</p>
<p>选择框架时，你不一定非得选择已经集成了 Flask 的框架，但选择这些框架可以节约你编写集成代码的时间。使用集成了 Flask 的框架可以简化配置和操作，所以专门为 Flask 开发的扩展是你的首选。</p>
<p>关于选择使用的数据库框架，选择的是 Flask-SQLAlchemy。</p>
<h2 id="安装-Flask-SQLAlchemy"><a href="#安装-Flask-SQLAlchemy" class="headerlink" title="安装 Flask-SQLAlchemy"></a>安装 Flask-SQLAlchemy</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install flask-sqlalchemy</div></pre></td></tr></table></figure>
<h2 id="配置-Flask-SQLAlchemy"><a href="#配置-Flask-SQLAlchemy" class="headerlink" title="配置 Flask-SQLAlchemy"></a>配置 Flask-SQLAlchemy</h2><p>在 Flask-SQLAlchemy 中，数据库使用URL指定。</p>
<blockquote>
<p>MySQL :  mysql://username:password@hostname/database<br>Postgres ：  postgresql://username:password@hostname/database<br>SQLite : sqlite:////absolute/path/to/database</p>
</blockquote>
<p>在这些 URL 中，hostname 表示 MySQL 服务所在的主机，可以是本地主机（localhost），也可以是远程服务器。数据库服务器上可以托管多个数据库，因此 database 表示要使用的数据库名。如果数据库需要进行认证，username 和 password 表示数据库的用户名和密码。</p>
<p>SQLite 数据库不需要使用服务器，因此不用指定 hostname、username 和 password。 URL 中的 database 是硬盘上文件的文件名。</p>
<p>程序使用的数据库URL必须保存到 Flask 配置对象的 <code>SQLALCHEMY_DATABASE_URI</code> 键中。配置对象中还有一个很有用的选项，即 <code>SQLALCHEMY_ON_REARDOWN</code> 键，将其设置为 <code>True</code> 时，每次请求结束后都会自动提交数据库中的变动。</p>
<p>我们使用 SQLite 数据库，配置代码 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</div><div class="line"><span class="keyword">from</span> flask.ext.sqlalchemy <span class="keyword">import</span> SQLAlchemy</div><div class="line"><span class="keyword">import</span> os</div><div class="line"></div><div class="line">baseDir = os.path.abspath(os.path.dirname(__file__))</div><div class="line"></div><div class="line">app = Flask(__name__)</div><div class="line">app.config[<span class="string">'SQLALCHEMY_DATABASE_URI'</span>] =\</div><div class="line">                                      <span class="string">'sqlite:////'</span> + os.path.join(baseDir,<span class="string">'data.sqlite'</span>)</div><div class="line">app.config[<span class="string">'SQLALCHEMY_COMMIT_ON_TEARDOWN'</span>] = <span class="keyword">True</span></div><div class="line"></div><div class="line">db = SQLAlchemy(app)</div></pre></td></tr></table></figure>
<h2 id="定义模型"><a href="#定义模型" class="headerlink" title="定义模型"></a>定义模型</h2><p>定义一个用户表 users 和一个角色表 roles，代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(db.Model)</span>:</span></div><div class="line">    __tablename__ = <span class="string">'users'</span></div><div class="line">    id = db.Column(db.Integer,primary_key=<span class="keyword">True</span>)</div><div class="line">    username = db.Column(db.String(<span class="number">64</span>),unique=<span class="keyword">True</span>,index=<span class="keyword">True</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> <span class="string">'&lt;User %r&gt;'</span> % self.username</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Role</span><span class="params">(db.Model)</span>:</span></div><div class="line">    __tablename__ = <span class="string">'roles'</span></div><div class="line">    id = db.Column(db.Integer,primary_key=<span class="keyword">True</span>)</div><div class="line">    name = db.Column(db.String(<span class="number">64</span>),unique=<span class="keyword">True</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> <span class="string">'&lt;Role %r&gt;'</span> % self.name</div></pre></td></tr></table></figure>
<p>解释下：  </p>
<blockquote>
<p>0.两个类 <code>User</code> 和 <code>Role</code> 继承自 <code>db.Model</code><br>1.<code>__tablename__</code>用来指定表名称<br>2.<code>db.Column()</code> 函数指定了数据库中字段的类型，是否是主键（ primary_key ），是否唯一( unique )，是否加索引( index ),还有其他的比如：是否可以为空（ nullable=True ）,默认值（ default ）</p>
</blockquote>
<h2 id="关系"><a href="#关系" class="headerlink" title="关系"></a>关系</h2><p>使用关系型数据库，不指定关系怎么能行。定义模型中我们没有指定关系，一个用户有一个角色，一个角色可以属于多个用户，典型的一对多的关系，如何在 Flask-SQLAlchemy 中定义关系？</p>
<p>上代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(db.Model)</span>:</span></div><div class="line">    __tablename__ = <span class="string">'users'</span></div><div class="line">    id = db.Column(db.Integer,primary_key=<span class="keyword">True</span>)</div><div class="line">    username = db.Column(db.String(<span class="number">64</span>),unique=<span class="keyword">True</span>,index=<span class="keyword">True</span>)</div><div class="line"></div><div class="line">    role_id = db.Column(db.Integer,db.ForeignKey(<span class="string">'roles.id'</span>))</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> <span class="string">'&lt;User %r&gt;'</span> % self.username</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Role</span><span class="params">(db.Model)</span>:</span></div><div class="line">    __tablename__ = <span class="string">'roles'</span></div><div class="line">    id = db.Column(db.Integer,primary_key=<span class="keyword">True</span>)</div><div class="line">    name = db.Column(db.String(<span class="number">64</span>),unique=<span class="keyword">True</span>)</div><div class="line"></div><div class="line">    users = db.relationship(<span class="string">'User'</span>,backref=<span class="string">'role'</span>)</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> <span class="string">'&lt;Role %r&gt;'</span> % self.name</div></pre></td></tr></table></figure>
<p>添加了两行代码：</p>
<p>第一行 <code>User</code> 类中：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">role_id = db.Column(db.Integer,db.ForeignKey(<span class="string">'roles.id'</span>))</div></pre></td></tr></table></figure>
<p>这句话比较好理解，和上面普通变量差不多，就是 <code>User</code> 类中添加了一个 <code>role_id</code> 变量，数据类型 <code>db.Integer</code>,第二个参数指定外键是哪个表中哪个 <code>id</code>。</p>
<p>第二行 <code>Role</code> 类中：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">users = db.Relationship(<span class="string">'User'</span>,backref=<span class="string">'role'</span>)</div></pre></td></tr></table></figure>
<p>这句话比较复杂，仔细读下面的话：</p>
<blockquote>
<p>0.添加到 <code>Role</code> 模型中的 <code>users</code> 属性代表这个关系的面向对象视角。对于一个 <code>Role</code> 类的实例，其 <code>users</code> 属性将返回与角色相关联的用户组成的列表。<br>1.<code>db.Relationship()</code> 第一个参数表明这个关系的另一端是哪个模型（类）。如果模型类尚未定义，可使用字符串形式指定。<br>2.<code>db.Relationship()</code> 第二个参数 <code>backref</code>，将向 <code>User</code> 类中添加一个 <code>role</code> 属性，从而定义反向关系。这一属性可替代 <code>role_id</code> 访问 <code>Role</code> 模型，此时获取的是模型对象，而不是外键的值。</p>
</blockquote>
<p>上面的关系为一对多关系的表示，一对一怎么办？</p>
<p>调用 <code>db.Relationship()</code> 时需要把 <code>userlist</code> 参数设置为 <code>False</code>。如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">db.Relationship(<span class="string">'User'</span>,backref=<span class="string">'role'</span>,uselist=<span class="keyword">False</span>)</div></pre></td></tr></table></figure>
<p>至于多对多关系，以后会慢慢介绍。</p>
<h2 id="数据库操作"><a href="#数据库操作" class="headerlink" title="数据库操作"></a>数据库操作</h2><p>数据库操作，基本的一些：数据库、表创建或删除，数据的增删改查。</p>
<h4 id="创建数据库和表"><a href="#创建数据库和表" class="headerlink" title="创建数据库和表"></a>创建数据库和表</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">db.create_all()</div></pre></td></tr></table></figure>
<p>上面说的 users 表和 roles 表就创建了。</p>
<h4 id="删除数据库"><a href="#删除数据库" class="headerlink" title="删除数据库"></a>删除数据库</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">db.drop_all()</div></pre></td></tr></table></figure>
<h4 id="插入行"><a href="#插入行" class="headerlink" title="插入行"></a>插入行</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">role_admin = Role(name=<span class="string">'Admin'</span>)</div><div class="line">user_tom = User(username=<span class="string">'tom'</span>,role=role_admin)</div><div class="line">user_jim = User(username=<span class="string">'jim'</span>,role=role_admin)</div><div class="line">user_tim = User(username=<span class="string">'tim'</span>,role=role_admin)</div><div class="line">user_sam = User(username=<span class="string">'sam'</span>,role=role_admin)</div><div class="line">db.session.add(role_admin)</div><div class="line">db.session.add(user_tom)</div><div class="line">db.session.add(user_jim)</div><div class="line">db.session.commit()</div></pre></td></tr></table></figure>
<p>通过数据库会话管理对数据库所做的改动，在 Flask-SQLAlchemy 中，会话由<code>db.session</code> 表示，准备把队形写入数据库之前，先要将其添加到会话中。写入数据库需要调用 <code>db.session.commit()</code> 方法。</p>
<h4 id="修改行"><a href="#修改行" class="headerlink" title="修改行"></a>修改行</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 我们将 role_admin 变量中 name 为 Admin 改成 Administrator。 </span></div><div class="line"></div><div class="line">role_admin.name=<span class="string">'Administrator'</span></div><div class="line">db.session.add(role_admin)</div><div class="line">db.session.commit()</div></pre></td></tr></table></figure>
<h4 id="删除行"><a href="#删除行" class="headerlink" title="删除行"></a>删除行</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 删除 Jim 用户</span></div><div class="line"></div><div class="line">db.session.delete(user_jim)</div><div class="line">db.session.commit()</div></pre></td></tr></table></figure>
<h4 id="查询行"><a href="#查询行" class="headerlink" title="查询行"></a>查询行</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 查询所有用户</span></div><div class="line">User.query.all() <span class="comment">#返回结果：[&lt;User 'tom'&gt;, &lt;User 'tim'&gt;, &lt;User 'sam'&gt;]</span></div></pre></td></tr></table></figure>
<p>更多相关方面文档请参考：<a href="http://docs.sqlalchemy.org" target="_blank" rel="external"> SQLAlchemy 文档</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/2015/04/19/ios-mi-ma-cun-chu/" class="prev">上一篇</a><a href="/2015/04/07/flask-web-05/" class="next">下一篇</a></div><div data-thread-key="2015/04/08/flask-web-06/" data-title="Flask Web 开发学习笔记（六）" data-url="http://iYiming.me/2015/04/08/flask-web-06/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"jiajiayouba"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2014 - 2016 <a href="http://iYiming.me">iYiming</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1253468447'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s6.cnzz.com/z_stat.php%3Fid%3D1253468447%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script></body></html>