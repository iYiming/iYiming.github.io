<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> iOS 7 之转场动画 · 一鸣的博客</title><meta name="description" content="iOS 7 之转场动画 - iYiming"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.jpg"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://iYiming.me/atom.xml" title="一鸣的博客"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/jiajiayouba" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/iYiming" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">iOS 7 之转场动画</h1><div class="post-info">2015年5月31日</div><div class="post-content"><p>iOS 7 添加了转场动画，让我们更加方便的切换控制器。iOS 7 SDK 支持两种自定义过渡：</p>
<ul>
<li>自定义视图控制器过渡</li>
<li>交互式视图控制器过渡</li>
</ul>
<p>怎么来区分自定义视图控制器过渡和交互式试图控制器过渡呢？</p>
<blockquote>
<p>当过渡是时间的函数式，它通常是一个自定义视图控制器过渡</p>
<p>如果他是一个手势识别器或者其他类似事件的函数，它通常是一个交互式视图控制器过渡</p>
</blockquote>
<p>比如：<code>UINavigationController</code> 过渡使我们最常见的自定义视图控制器过渡。<code>UIPageViewController</code> 过渡不是随着时间进行，它需要跟随我们的手指滑动，所以它是一种交互式视图控制器过渡。</p>
<h1 id="自定义视图控制器过渡"><a href="#自定义视图控制器过渡" class="headerlink" title="自定义视图控制器过渡"></a>自定义视图控制器过渡</h1><p>实现自定义视图控制器过渡有两种方式：</p>
<ul>
<li>使用 Storyboard 实现</li>
<li>代码方式实现</li>
</ul>
<h2 id="使用-Storyboard-来实现自定义视图控制器过渡"><a href="#使用-Storyboard-来实现自定义视图控制器过渡" class="headerlink" title="使用 Storyboard 来实现自定义视图控制器过渡"></a>使用 Storyboard 来实现自定义视图控制器过渡</h2><p>我们可以使用连线（ segue ）的方式，来实现自定义视图控制器过渡，segue 有好几种类型，<br>选择某个 segue，我们可以看到下图：  </p>
<p><img src="/images/TransitionAnimation/0.png" alt="0.png"></p>
<p>我们选择自定义这种方式可以看到：</p>
<p><img src="/images/TransitionAnimation/3.png" alt="3.png">  </p>
<p>我们可以指定 segue Class 它是一个 <code>UIStoryboardSegue</code> 子类，我们可以创建一个 <code>UIStoryboardSegue</code> 子类 <code>IYMCustomSegue</code>，填写在这里。</p>
<p>在 <code>UIStoryboardSegue</code> 里有个 <code>perform</code> 方法，我们在 <code>IYMCustomSegue</code> 重写一下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)perfrom&#123;</div><div class="line">  <span class="comment">//这里实现动画</span></div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面实现一个自定义 push 动画：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)perform &#123;</div><div class="line">  UIViewController *sourceViewController = self.sourceViewController;</div><div class="line">UIViewController *desinationViewController = self.destinationViewController;</div><div class="line"></div><div class="line">  CGRect sourceRect = sourceViewController.view.frame;</div><div class="line">  CGRect desinationViewFromRect = CGRectMake(sourceRect.origin.x + sourceRect.size.width, sourceRect.origin.y, sourceRect.size.width, sourceRect.size.height);</div><div class="line">  desinationViewController.view.frame = desinationViewFromRect;</div><div class="line">  desinationViewController.view.alpha = <span class="number">0</span>;</div><div class="line">  [sourceViewController.view.superview addSubview:desinationViewController.view];</div><div class="line"></div><div class="line">  [UIView animateWithDuration:<span class="number">0.3</span> animations:^&#123;</div><div class="line">  sourceViewController.view.alpha = <span class="number">0.5</span>;</div><div class="line">  desinationViewController.view.alpha = <span class="number">1</span>;</div><div class="line">  desinationViewController.view.frame = sourceRect;</div><div class="line">&#125; completion:^(BOOL finished) &#123;</div><div class="line">  sourceViewController.view.alpha = <span class="number">1</span>;</div><div class="line">  [desinationViewController.view removeFromSuperview];</div><div class="line"></div><div class="line">  [sourceViewController.navigationController pushViewController:desinationViewController animated:NO];</div><div class="line">  &#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="代码方式实现"><a href="#代码方式实现" class="headerlink" title="代码方式实现"></a>代码方式实现</h2><p>自定义试图控制器过渡是由两个协议实现的，即<code>UIViewControllerTransitioningDelegate</code> 和 <code>UIViewControllerAnimatedTransitioning</code>。</p>
<p>我们从 A 控制器到 B 控制器，通常有两种方式：  </p>
<ul>
<li><code>presentViewController</code> 方式</li>
<li><code>pushViewController</code> 方式</li>
</ul>
<h4 id="使用-presentViewController-方式：从-A-控制器-present-到-B-控制器"><a href="#使用-presentViewController-方式：从-A-控制器-present-到-B-控制器" class="headerlink" title="使用 presentViewController 方式：从 A 控制器 present 到 B 控制器"></a>使用 presentViewController 方式：从 A 控制器 present 到 B 控制器</h4><ol>
<li>设置 B 控制器的 <code>transitionDelegate</code> 为 A 控制器  </li>
<li>在 A 控制器中实现 <code>UIViewControllerTransitioningDelegate</code> 协议  </li>
<li>实现 <code>UIViewControllerAnimatedTransitioning</code>  </li>
</ol>
<p>实现 <code>UIViewControllerTransitioningDelegate</code> 中的方法：  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- (id &lt;UIViewControllerAnimatedTransitioning&gt;)animationControllerForPresentedController:(UIViewController *)presented presentingController:(UIViewController *)presenting sourceController:(UIViewController *)source;</div><div class="line"></div><div class="line">- (id &lt;UIViewControllerAnimatedTransitioning&gt;)animationControllerForDismissedController:(UIViewController *)dismissed;</div></pre></td></tr></table></figure>
<p>这两个方法返回的是一个实现了 <code>UIViewControllerAnimatedTransitioning</code> 协议的类实例。通过方法名字我们就可以看到它们适用于 <code>presentViewController</code> 方式。如果自定义过渡效果只有一个视图控制器使用，视图控制器本身就可以实现<code>UIViewControllerAnimatedTransitioning</code> 协议，否则，就需要一个单独的继承自<code>NSObject</code> 一个单独的类来实现 <code>UIViewControllerAnimatedTransitioning</code> 协议。</p>
<p>这里我们就实现一个 B 视图控制器过渡动画，就直接在 A 控制器中实现<code>UIViewControllerAnimatedTransitioning</code>。</p>
<p>实现 <code>UIViewControllerTransitioningDelegate</code> 中的方法：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// This is used for percent driven interactive transitions, as well as for container controllers that have companion animations that might need to</span></div><div class="line"><span class="comment">// synchronize with the main animation. </span></div><div class="line">- (NSTimeInterval)transitionDuration:(id &lt;UIViewControllerContextTransitioning&gt;)transitionContext&#123;</div><div class="line">  <span class="comment">//返回动画时间</span></div><div class="line">  <span class="keyword">return</span> <span class="number">1.0f</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// This method can only  be a nop if the transition is interactive and not a percentDriven interactive transition.</span></div><div class="line">- (<span class="keyword">void</span>)animateTransition:(id &lt;UIViewControllerContextTransitioning&gt;)transitionContext&#123;</div><div class="line">  <span class="comment">//动画代码在这里写</span></div><div class="line">  ...</div><div class="line"></div><div class="line">  [transitionContext completeTransition:YES];<span class="comment">//必须实现这个方法</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>- (void)animateTransition:(id &lt;UIViewControllerContextTransitioning&gt;)transitionContext</code>中的 <code>transitionContext</code> ，我们可以获得：</p>
<p>源控制器即来自哪个视图控制器：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">UIViewController *src = [transitionContext viewControllerForKey:UITransitionContextFromViewControllerKey];</div></pre></td></tr></table></figure>
<p>目标控制器，这里是B控制器:  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">UIViewController *dest = [transitionContext viewControllerForKey:UITransitionContextToViewControllerKey];</div></pre></td></tr></table></figure>
<p>容器视图：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">UIView *containerView = [transitionContext containerView];</div></pre></td></tr></table></figure>
<h4 id="使用-pushViewController-方式：从-A-控制器-push-到-B-控制器"><a href="#使用-pushViewController-方式：从-A-控制器-push-到-B-控制器" class="headerlink" title="使用 pushViewController 方式：从 A 控制器 push 到 B 控制器"></a>使用 pushViewController 方式：从 A 控制器 push 到 B 控制器</h4><p>因为是从 A 控制器 push 到 B 控制器，我们不需要实现 <code>UIViewControllerTransitioningDelegate</code> 中的方法，我们需要：</p>
<ol>
<li>在 A 控制器设置 <code>UINavigationDelegate</code> 为 <code>self</code>  </li>
<li>实现 <code>UINavigationDelegate</code>  </li>
<li>实现 <code>UIViewControllerAnimatedTransitioning</code> 协议  </li>
</ol>
<p>实现 <code>UINavigationDelegate</code> 中的方法：  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- (id &lt;UIViewControllerAnimatedTransitioning&gt;)navigationController:(UINavigationController *)navigationController</div><div class="line">animationControllerForOperation:(UINavigationControllerOperation)operation</div><div class="line">fromViewController:(UIViewController *)fromVC</div><div class="line">toViewController:(UIViewController *)toVC;</div></pre></td></tr></table></figure>
<p>返回的是一个实现了 <code>UIViewControllerAnimatedTransitioning</code> 协议的类实例。这个和 <code>presentViewController</code> 方式一样。</p>
<h1 id="交互式视图控制器过渡"><a href="#交互式视图控制器过渡" class="headerlink" title="交互式视图控制器过渡"></a>交互式视图控制器过渡</h1><p>要实现一个交互式视图控制器过渡，除了要是上面的动画外，还要告诉交互控制器动画完成了多少，我们只要知道完成了多少百分比，告诉系统，系统就直接给咱们处理了。通过计算手势/动作事件或其他驱动过渡的事件，可以得出百分比。例如通过 <code>UIScreenEdgePanGestureRecognizer</code> 边缘返回手势，我们可以通过平移量来查看返回完成了多少。</p>
<p>视图控制器过渡方式还是要分成 2 种:  </p>
<ul>
<li><code>presentViewController</code> 方式</li>
<li><code>pushViewController</code> 方式</li>
</ul>
<h2 id="使用-presentViewController-方式"><a href="#使用-presentViewController-方式" class="headerlink" title="使用 presentViewController 方式"></a>使用 presentViewController 方式</h2><p>除了上面 presentViewController 方式实现的协议方法外，我们还需要实现 UIViewControllerTransitioningDelegate 中的另外两个方法：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- (id &lt;UIViewControllerInteractiveTransitioning&gt;)interactionControllerForPresentation:(id &lt;UIViewControllerAnimatedTransitioning&gt;)animator;</div><div class="line"></div><div class="line">- (id &lt;UIViewControllerInteractiveTransitioning&gt;)interactionControllerForDismissal:(id &lt;UIViewControllerAnimatedTransitioning&gt;)animator;</div></pre></td></tr></table></figure>
<p>交互控制器实现了 UIViewControllerInteractiveTransitioning 协议。交互式过渡的交互控制器都必须是 UIPercentDrivenInteractiveTransition 实例或者 UIPercentDrivenInteractiveTransition 子类实例。</p>
<p>UIPercentDrivenInteractiveTransition 中以下方法可以完成交互过渡：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)updateInteractiveTransition:(CGFloat)percentComplete;<span class="comment">//完成了多少，percentComplete是百分比</span></div><div class="line">- (<span class="keyword">void</span>)cancelInteractiveTransition;<span class="comment">//取消</span></div><div class="line">- (<span class="keyword">void</span>)finishInteractiveTransition;<span class="comment">//完成</span></div></pre></td></tr></table></figure>
<p>例如我们给 B 控制器（A 控制器 present to B控制器），B 控制器通过缩放到达 A 控制器，我们给B控制器视图添加了一个缩放手势 <code>UIPinchGestureRecognizer</code>。</p>
<p>上面的 <code>UIViewControllerTransitioningDelegate</code> 我们返回一个  <code>[[UIPercentDrivenInteractiveTransition alloc] init]</code> 实例  <code>percentDrivenInteractiveTransition</code> 。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)pinchGestureAction:(UIPinchGestureRecognizer*) gestureRecognizer &#123;</div><div class="line">  CGFloat scale = gestureRecognizer.scale;</div><div class="line">  <span class="keyword">if</span>(gestureRecognizer.state == UIGestureRecognizerStateBegan) &#123;</div><div class="line">    self.percentDrivenInteractiveTransition = [[UIPercentDrivenInteractiveTransition alloc] init];</div><div class="line">    self.startScale = scale;</div><div class="line">    [self.controller dismissViewControllerAnimated:YES completion:nil];</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (gestureRecognizer.state == UIGestureRecognizerStateChanged) &#123;</div><div class="line"></div><div class="line">    CGFloat completePercent = <span class="number">1.0</span> - (scale/self.startScale);</div><div class="line">    [self updateInteractiveTransition:completePercent];<span class="comment">//完成了多少百分比</span></div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (gestureRecognizer.state == UIGestureRecognizerStateEnded)  &#123;</div><div class="line">    <span class="keyword">if</span>(gestureRecognizer.velocity &gt;= <span class="number">0</span>)&#123;</div><div class="line">      [self cancelInteractiveTransition];<span class="comment">//取消</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      [self finishInteractiveTransition];<span class="comment">//完成</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    self.percentDrivenInteractiveTransition = nil;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span>(gestureRecognizer.state == UIGestureRecognizerStateCancelled) &#123;</div><div class="line">    [self cancelInteractiveTransition];<span class="comment">//取消</span></div><div class="line">    self.percentDrivenInteractiveTransition = nil;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="使用-pushViewController-方式"><a href="#使用-pushViewController-方式" class="headerlink" title="使用 pushViewController 方式"></a>使用 pushViewController 方式</h2><p>和 present 方式不同的一点是，我们使用 <code>UINavigationDelegate</code> 中的：  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">- (id &lt;UIViewControllerInteractiveTransitioning&gt;)navigationController:(UINavigationController *)navigationController</div><div class="line">interactionControllerForAnimationController:(id &lt;UIViewControllerAnimatedTransitioning&gt;) animationController</div></pre></td></tr></table></figure>
<p>来代替：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- (id &lt;UIViewControllerInteractiveTransitioning&gt;)interactionControllerForPresentation:(id &lt;UIViewControllerAnimatedTransitioning&gt;)animator;</div><div class="line"></div><div class="line">- (id &lt;UIViewControllerInteractiveTransitioning&gt;)interactionControllerForDismissal:(id &lt;UIViewControllerAnimatedTransitioning&gt;)animator;</div></pre></td></tr></table></figure>
<p>其他的都一样。</p>
<h1 id="一个完整的例子"><a href="#一个完整的例子" class="headerlink" title="一个完整的例子"></a>一个完整的例子</h1><p>单击图片展示大图，返回慢慢缩放到小图，效果如下:  </p>
<p><img src="/images/TransitionAnimation/1.gif" alt="1.gif"></p>
<p>将用到： </p>
<ul>
<li>UINavigationDelegate  </li>
<li>返回手势  </li>
<li>交互式过渡效果  </li>
</ul>
<h2 id="新建-2-个控制器"><a href="#新建-2-个控制器" class="headerlink" title="新建 2 个控制器"></a>新建 2 个控制器</h2><ul>
<li>首页：<code>IYMFirstViewController</code></li>
<li>喵星人：<code>IYMSecondViewController</code></li>
</ul>
<h2 id="使用-Storyboard-创建两个视图"><a href="#使用-Storyboard-创建两个视图" class="headerlink" title="使用 Storyboard 创建两个视图"></a>使用 Storyboard 创建两个视图</h2><p><img src="/images/TransitionAnimation/2.png" alt="2.png"></p>
<h4 id="设置-UINavigationDelegate"><a href="#设置-UINavigationDelegate" class="headerlink" title="设置 UINavigationDelegate"></a>设置 UINavigationDelegate</h4><p>IYMFirstViewController.m IYMSecondViewController.m 分别重写以下方法：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)viewDidAppear:(BOOL)animated &#123;</div><div class="line">[super viewDidAppear:animated];</div><div class="line"></div><div class="line"><span class="comment">// Set outself as the navigation controller's delegate so we're asked for a transitioning object</span></div><div class="line">self.navigationController.delegate = self;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewWillDisappear:(BOOL)animated &#123;</div><div class="line">[super viewWillDisappear:animated];</div><div class="line"></div><div class="line"><span class="comment">// Stop being the navigation controller's delegate</span></div><div class="line"><span class="keyword">if</span> (self.navigationController.delegate == self) &#123;</div><div class="line">self.navigationController.delegate = nil;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="实现-UINavigationDelegate"><a href="#实现-UINavigationDelegate" class="headerlink" title="实现 UINavigationDelegate"></a>实现 UINavigationDelegate</h4><p>IYMFirstViewController.m 中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">- (id &lt;UIViewControllerAnimatedTransitioning&gt;)navigationController:(UINavigationController *)navigationController</div><div class="line">animationControllerForOperation:(UINavigationControllerOperation)operation</div><div class="line">fromViewController:(UIViewController *)fromVC</div><div class="line">toViewController:(UIViewController *)toVC&#123;</div><div class="line"><span class="comment">// Check if we're transitioning from this view controller to a DSLSecondViewController</span></div><div class="line"><span class="keyword">if</span> (fromVC == self &amp;&amp; [toVC isKindOfClass:[IYMSecondViewController <span class="keyword">class</span>]]) &#123;</div><div class="line"><span class="keyword">return</span> self;</div><div class="line">&#125;<span class="keyword">else</span> &#123;</div><div class="line"><span class="keyword">return</span> nil;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>IYMSecondViewController.m</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">- (id &lt;UIViewControllerInteractiveTransitioning&gt;)navigationController:(UINavigationController *)navigationController</div><div class="line">interactionControllerForAnimationController:(id &lt;UIViewControllerAnimatedTransitioning&gt;) animationController&#123;</div><div class="line">  <span class="keyword">return</span> <span class="number">_</span>percentDrivenInteractiveTransition;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (id &lt;UIViewControllerAnimatedTransitioning&gt;)navigationController:(UINavigationController *)navigationController</div><div class="line">animationControllerForOperation:(UINavigationControllerOperation)operation</div><div class="line">fromViewController:(UIViewController *)fromVC</div><div class="line">toViewController:(UIViewController *)toVC&#123;</div><div class="line">  <span class="keyword">if</span> (fromVC == self &amp;&amp; [toVC isKindOfClass:[IYMFirstViewController <span class="keyword">class</span>]]) &#123;</div><div class="line">    <span class="keyword">return</span> self;</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="keyword">return</span> nil;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中 <code>_percentDrivenInteractiveTransition</code> 是一个 <code>UIPercentDrivenInteractiveTransition</code> 实例，在边缘手势中实例化。</p>
<h2 id="实现-UIViewControllerAnimatedTransitioning"><a href="#实现-UIViewControllerAnimatedTransitioning" class="headerlink" title="实现 UIViewControllerAnimatedTransitioning"></a>实现 UIViewControllerAnimatedTransitioning</h2><p>IYMFirstViewController.m</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">- (NSTimeInterval) transitionDuration:(id&lt;UIViewControllerContextTransitioning&gt;)transitionContext</div><div class="line">&#123;</div><div class="line">  <span class="keyword">return</span> <span class="number">0.3f</span>;<span class="comment">//动画时间</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)animateTransition:(id &lt;UIViewControllerContextTransitioning&gt;)transitionContext &#123;</div><div class="line">  IYMFirstViewController *fromViewContrroller = (IYMFirstViewController *)[transitionContext viewControllerForKey:UITransitionContextFromViewControllerKey];</div><div class="line">IYMSecondViewController *toViewController = (IYMSecondViewController *)[transitionContext viewControllerForKey:UITransitionContextToViewControllerKey];</div><div class="line">  UIView *containerView = [transitionContext containerView];</div><div class="line"></div><div class="line">  UIView *snapshotView = [fromViewContrroller.bottomImageView snapshotViewAfterScreenUpdates:NO];<span class="comment">//截图</span></div><div class="line">  CGRect snapshotViewFromRect = [containerView convertRect:fromViewContrroller.bottomImageView.frame fromView:fromViewContrroller.view];<span class="comment">//获取在ContainerView中的frame</span></div><div class="line">snapshotView.frame = snapshotViewFromRect; </div><div class="line">toViewController.view.frame = [transitionContext finalFrameForViewController:toViewController];</div><div class="line">toViewController.view.alpha = <span class="number">0</span>;</div><div class="line">[containerView addSubview:toViewController.view];</div><div class="line">[containerView addSubview:snapshotView];</div><div class="line">fromViewContrroller.bottomImageView.hidden = YES;</div><div class="line">toViewController.topImageView.hidden = YES;</div><div class="line"></div><div class="line">CGRect snapshotViewToRect = [containerView convertRect:toViewController.topImageView.frame fromView:toViewController.view];</div><div class="line">[UIView animateWithDuration:<span class="number">0.3</span> animations:^&#123;</div><div class="line">toViewController.view.alpha = <span class="number">1</span>;</div><div class="line">snapshotView.frame = snapshotViewToRect;</div><div class="line">&#125; completion:^(BOOL finished) &#123;</div><div class="line"><span class="keyword">if</span> (finished) &#123;</div><div class="line">[snapshotView removeFromSuperview];</div><div class="line">fromViewContrroller.bottomImageView.hidden = NO;</div><div class="line">toViewController.topImageView.hidden = NO;</div><div class="line"></div><div class="line">[transitionContext completeTransition:!transitionContext.transitionWasCancelled];</div><div class="line">&#125;</div><div class="line">&#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>IYMSecondViewController.m</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">- (NSTimeInterval) transitionDuration:(id&lt;UIViewControllerContextTransitioning&gt;)transitionContext &#123;</div><div class="line"> return 0.3f;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)animateTransition:(id &lt;UIViewControllerContextTransitioning&gt;)transitionContext &#123;</div><div class="line">  IYMSecondViewController *fromViewController = (IYMSecondViewController *)[transitionContext viewControllerForKey:UITransitionContextFromViewControllerKey];</div><div class="line">IYMFirstViewController *toViewController = (IYMFirstViewController *)[transitionContext viewControllerForKey:UITransitionContextToViewControllerKey];</div><div class="line">UIView *containerView = [transitionContext containerView];</div><div class="line"></div><div class="line"></div><div class="line">UIView *snapshotView = [fromViewController.topImageView snapshotViewAfterScreenUpdates:NO];</div><div class="line">CGRect snapshotViewFromRect = [containerView convertRect:fromViewController.topImageView.frame fromView:fromViewController.view];</div><div class="line">snapshotView.frame = snapshotViewFromRect; // Setup the initial view states</div><div class="line">toViewController.view.frame = [transitionContext finalFrameForViewController:toViewController];</div><div class="line">toViewController.view.alpha = 0;</div><div class="line">[containerView insertSubview:toViewController.view belowSubview:fromViewController.view];</div><div class="line">[containerView addSubview:snapshotView];</div><div class="line">fromViewController.topImageView.hidden = YES;</div><div class="line">toViewController.bottomImageView.hidden = YES;</div><div class="line"></div><div class="line">CGRect snapshotViewToRect = [containerView convertRect:toViewController.bottomImageView.frame fromView:toViewController.view];</div><div class="line">[UIView animateWithDuration:0.3 animations:^&#123;</div><div class="line">toViewController.view.alpha = 1;</div><div class="line">snapshotView.frame = snapshotViewToRect;</div><div class="line">&#125; completion:^(BOOL finished) &#123;</div><div class="line">if (finished) &#123;</div><div class="line">[snapshotView removeFromSuperview];</div><div class="line">fromViewController.topImageView.hidden = NO;</div><div class="line">toViewController.bottomImageView.hidden = NO;</div><div class="line">// Declare that we&apos;ve finished</div><div class="line">[transitionContext completeTransition:!transitionContext.transitionWasCancelled];</div><div class="line">&#125;</div><div class="line">&#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="为-IYMSecondViewController-添加边缘返回手势"><a href="#为-IYMSecondViewController-添加边缘返回手势" class="headerlink" title="为 IYMSecondViewController 添加边缘返回手势"></a>为 IYMSecondViewController 添加边缘返回手势</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">UIScreenEdgePanGestureRecognizer *screenEdgePanGestureRecognizer = [[UIScreenEdgePanGestureRecognizer alloc] initWithTarget:self action:@selector(handleScreenEdgePanGesture:)];</div><div class="line">screenEdgePanGestureRecognizer.edges = UIRectEdgeLeft;</div><div class="line">[self.view addGestureRecognizer:screenEdgePanGestureRecognizer];</div></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>) handleScreenEdgePanGesture:(UIScreenEdgePanGestureRecognizer *) recognizer</div><div class="line">&#123;</div><div class="line">CGFloat progress = [recognizer translationInView:self.view].x / (self.view.bounds.size.width * <span class="number">1.0</span>);</div><div class="line">progress = MIN(<span class="number">1.0</span>, MAX(<span class="number">0.0</span>, progress));</div><div class="line"></div><div class="line"><span class="keyword">if</span> (recognizer.state == UIGestureRecognizerStateBegan) &#123;</div><div class="line"><span class="number">_</span>percentDrivenInteractiveTransition = [[UIPercentDrivenInteractiveTransition alloc] init];</div><div class="line">[self.navigationController popViewControllerAnimated:YES];</div><div class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span> (recognizer.state == UIGestureRecognizerStateChanged) &#123;</div><div class="line">[<span class="number">_</span>percentDrivenInteractiveTransition updateInteractiveTransition:progress];</div><div class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span> (recognizer.state == UIGestureRecognizerStateEnded || recognizer.state == UIGestureRecognizerStateCancelled) &#123;</div><div class="line"><span class="keyword">if</span> (progress &gt; <span class="number">0.5f</span>) &#123;</div><div class="line">[<span class="number">_</span>percentDrivenInteractiveTransition finishInteractiveTransition];</div><div class="line">&#125;<span class="keyword">else</span>&#123;</div><div class="line">[<span class="number">_</span>percentDrivenInteractiveTransition cancelInteractiveTransition];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="number">_</span>percentDrivenInteractiveTransition = nil;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></div></article></div></section><footer><div class="paginator"><a href="/2015/06/28/pop-dong-hua/" class="prev">上一篇</a><a href="/2015/05/17/watchkit-02/" class="next">下一篇</a></div><div data-thread-key="2015/05/31/ios7-transitionanimation/" data-title="iOS 7 之转场动画" data-url="http://iYiming.me/2015/05/31/ios7-transitionanimation/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"jiajiayouba"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2014 - 2017 <a href="http://iYiming.me">iYiming</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1253468447'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s6.cnzz.com/z_stat.php%3Fid%3D1253468447%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?3cec0b24b46b86302d1aa3b050d4668f";var s = document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm, s);})();</script></body></html>